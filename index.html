<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê≠¶Â∞Ü„Éá„Éº„ÇøÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --bg-input: #22222f;
            --border-color: #2a2a3a;
            --border-accent: #4a3a2a;
            --text-primary: #e8e4dc;
            --text-secondary: #9a9490;
            --text-muted: #6a6560;
            --accent-gold: #c9a227;
            --accent-gold-dim: #8a7020;
            --accent-red: #b83c3c;
            --accent-green: #3cb878;
            --accent-blue: #3c8cb8;
            --status-complete: #2a6a4a;
            --status-partial: #6a5a2a;
            --status-empty: #4a2a2a;
            --shadow-glow: 0 0 30px rgba(201, 162, 39, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1510 0%, #0a0a0f 100%);
            border-bottom: 2px solid var(--accent-gold-dim);
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30Z' fill='none' stroke='%23c9a227' stroke-width='0.5' opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .header h1 {
            font-family: 'Zen Maru Gothic', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(201, 162, 39, 0.3);
            position: relative;
            letter-spacing: 0.2em;
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 0.5rem;
            position: relative;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Progress Overview */
        .progress-overview {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-glow);
        }

        .progress-overview h2 {
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }

        .progress-item {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .progress-item.complete {
            border-color: var(--accent-green);
            background: var(--status-complete);
        }

        .progress-item.partial {
            border-color: var(--accent-gold);
            background: var(--status-partial);
        }

        .progress-item.empty {
            border-color: var(--accent-red);
            background: var(--status-empty);
        }

        .progress-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .progress-item .status {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0.3rem;
        }

        /* Form Sections */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: var(--border-accent);
        }

        .section-header {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            user-select: none;
        }

        .section-header h3 {
            font-size: 1.1rem;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .section-header .status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            background: var(--status-empty);
            color: var(--text-secondary);
        }

        .section-header .status-badge.complete {
            background: var(--status-complete);
            color: var(--accent-green);
        }

        .section-header .status-badge.partial {
            background: var(--status-partial);
            color: var(--accent-gold);
        }

        .section-header .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .section.collapsed .section-header .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 1.5rem;
            display: block;
        }

        .section.collapsed .section-content {
            display: none;
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.7rem 1rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.2);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        /* Checkbox & Radio Styles */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-input);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover, .radio-item:hover {
            border-color: var(--accent-gold-dim);
        }

        .checkbox-item input, .radio-item input {
            accent-color: var(--accent-gold);
            width: 16px;
            height: 16px;
        }

        .checkbox-item label, .radio-item label {
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }

        /* Equipment Card */
        .equipment-card {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .equipment-card h4 {
            color: var(--accent-gold);
            font-size: 0.95rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .equipment-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.8rem;
            align-items: end;
        }

        /* SP General Card */
        .sp-card {
            background: linear-gradient(135deg, var(--bg-input) 0%, #1a1520 100%);
            border: 1px solid var(--border-accent);
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
        }

        .sp-card h4 {
            color: var(--accent-gold);
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sp-card h4::before {
            content: '‚òÖ';
            color: var(--accent-gold);
        }

        /* Skill Grid */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.6rem;
        }

        .skill-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .skill-item input[type="checkbox"] {
            accent-color: var(--accent-gold);
        }

        .skill-item label {
            font-size: 0.8rem;
            flex: 1;
        }

        /* Flower Formation Grid */
        .flower-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.8rem;
        }

        .flower-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 0.8rem;
            background: var(--bg-input);
            padding: 0.7rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .flower-item .name {
            font-size: 0.85rem;
        }

        .flower-item .effect {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .flower-item .checkboxes {
            display: flex;
            gap: 0.8rem;
        }

        .flower-item .checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Tactic Card */
        .tactic-card {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr auto auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .tactic-card .name {
            font-weight: 500;
        }

        .tactic-card input[type="number"] {
            width: 70px;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .tactic-card select {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        /* Admin Section */
        .admin-section {
            background: linear-gradient(135deg, #1a1015 0%, #0a0a0f 100%);
            border: 2px solid var(--accent-red);
            border-radius: 12px;
            margin-top: 2rem;
            overflow: hidden;
        }

        .admin-header {
            background: rgba(184, 60, 60, 0.1);
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h3 {
            color: var(--accent-red);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .admin-password {
            padding: 1.5rem;
            display: none;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-password.show {
            display: block;
        }

        .admin-password input {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.7rem 1rem;
            color: var(--text-primary);
            width: 200px;
            margin-right: 0.5rem;
        }

        .admin-password button {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .admin-password button:hover {
            background: #d04040;
        }

        .admin-content {
            padding: 1.5rem;
            display: none;
        }

        .admin-content.show {
            display: block;
        }

        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .admin-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.7rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-btn:hover {
            border-color: var(--accent-gold);
            background: var(--bg-secondary);
        }

        .admin-btn.primary {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
        }

        .admin-btn.primary:hover {
            background: #dab530;
        }

        .admin-btn.danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .admin-btn.danger:hover {
            background: rgba(184, 60, 60, 0.2);
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th, .data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--accent-gold);
            font-weight: 500;
        }

        .data-table tr:hover {
            background: var(--bg-input);
        }

        .data-table .actions {
            display: flex;
            gap: 0.5rem;
        }

        .data-table .actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* General List Editor */
        .general-list {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .general-list h4 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }

        .general-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 1024px) {
            .general-categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .general-categories {
                grid-template-columns: 1fr;
            }
        }

        .general-category {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
        }

        .general-category-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-gold);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .general-grid {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .general-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .general-item .general-name {
            flex: 1;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            user-select: none;
        }

        .general-item .general-name:hover {
            background: var(--bg-input);
        }

        /* State: Owned (ÊâÄÊåÅ) */
        .general-item.owned {
            border-color: var(--accent-blue);
            background: rgba(60, 140, 184, 0.1);
        }

        .general-item.owned .general-name {
            color: var(--accent-blue);
            font-weight: 500;
        }

        .general-item.owned .general-name::before {
            content: '‚óá ';
        }

        /* State: Formed (Á∑®Êàê) */
        .general-item.formed {
            border-color: var(--accent-green);
            background: rgba(60, 184, 120, 0.1);
        }

        .general-item.formed .general-name {
            color: var(--accent-green);
            font-weight: 500;
        }

        .general-item.formed .general-name::before {
            content: '‚úì ';
        }

        .general-item .status-badge {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            display: none;
        }

        .general-item.owned .status-badge {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
        }

        .general-item.owned .status-badge::after {
            content: 'ÊâÄÊåÅ';
        }

        .general-item.formed .status-badge {
            display: inline-block;
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .general-item.formed .status-badge::after {
            content: 'Á∑®Êàê';
        }

        .general-item input[type="number"] {
            width: 45px;
            padding: 0.2rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            text-align: center;
            font-size: 0.8rem;
        }

        /* Custom General Input */
        .custom-general {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
        }

        .custom-general h5 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
        }

        .custom-general-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .custom-general-row input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .custom-general-row input:first-child {
            flex: 2;
        }

        .custom-general-row button {
            padding: 0.5rem 1rem;
            background: var(--accent-gold-dim);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
        }

        /* Submit Button */
        .submit-section {
            text-align: center;
            padding: 2rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #a08020 100%);
            color: var(--bg-primary);
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(201, 162, 39, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(201, 162, 39, 0.4);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Comparison Section */
        .comparison-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .comparison-section h4 {
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-selector {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .user-selector h5 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
        }

        .user-checkbox-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .user-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--bg-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-checkbox-item:hover {
            border-color: var(--accent-gold-dim);
        }

        .user-checkbox-item.selected {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .user-checkbox-item input {
            accent-color: var(--accent-gold);
        }

        .user-checkbox-item label {
            font-size: 0.85rem;
            cursor: pointer;
        }

        .compare-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }

        .compare-btn:hover {
            background: #4a9cc8;
        }

        .compare-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .comparison-results {
            display: none;
        }

        .comparison-results.show {
            display: block;
        }

        .comparison-category {
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .comparison-category-header {
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .comparison-category-header.overlap {
            background: linear-gradient(90deg, rgba(184, 60, 60, 0.2) 0%, var(--bg-input) 100%);
            border-left: 3px solid var(--accent-red);
        }

        .comparison-category-header.unused {
            background: linear-gradient(90deg, rgba(60, 140, 184, 0.2) 0%, var(--bg-input) 100%);
            border-left: 3px solid var(--accent-blue);
        }

        .comparison-category-header.inconsistent {
            background: linear-gradient(90deg, rgba(201, 162, 39, 0.2) 0%, var(--bg-input) 100%);
            border-left: 3px solid var(--accent-gold);
        }

        .comparison-category-header h5 {
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comparison-category-header .count {
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .comparison-category-content {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .comparison-item {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .comparison-item:last-child {
            margin-bottom: 0;
        }

        .comparison-item .item-name {
            font-weight: 500;
            min-width: 150px;
        }

        .comparison-item .item-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.2rem 0.5rem;
            background: var(--bg-card);
            border-radius: 4px;
        }

        .comparison-item .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .comparison-item .user-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--accent-gold-dim);
            color: var(--text-primary);
        }

        .comparison-item .user-tag.warning {
            background: var(--accent-red);
        }

        .no-issues {
            text-align: center;
            padding: 2rem;
            color: var(--accent-green);
        }

        .no-issues .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Comparison Sub-categories */
        .comparison-subcategory {
            margin-bottom: 0.8rem;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .comparison-subcategory-header {
            padding: 0.6rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            user-select: none;
        }

        .comparison-subcategory-header .subcat-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .comparison-subcategory-header .subcat-count {
            font-size: 0.75rem;
            padding: 0.1rem 0.5rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }

        .comparison-subcategory-content {
            padding: 0.8rem;
            display: none;
            border-top: 1px solid var(--border-color);
        }

        .comparison-subcategory-content.show {
            display: block;
        }

        /* Sub-category colors by type */
        .subcat-weapon {
            background: linear-gradient(90deg, rgba(184, 80, 60, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #b85040;
        }
        .subcat-spgeneral {
            background: linear-gradient(90deg, rgba(201, 162, 39, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--accent-gold);
        }
        .subcat-general {
            background: linear-gradient(90deg, rgba(100, 160, 100, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #64a064;
        }
        .subcat-academy {
            background: linear-gradient(90deg, rgba(80, 140, 180, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #508cb4;
        }
        .subcat-mask {
            background: linear-gradient(90deg, rgba(140, 100, 180, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #8c64b4;
        }
        .subcat-flower {
            background: linear-gradient(90deg, rgba(220, 120, 160, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #dc78a0;
        }
        .subcat-horse {
            background: linear-gradient(90deg, rgba(160, 120, 80, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #a07850;
        }
        .subcat-tactic {
            background: linear-gradient(90deg, rgba(60, 140, 184, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid var(--accent-blue);
        }
        .subcat-asura {
            background: linear-gradient(90deg, rgba(180, 60, 60, 0.15) 0%, var(--bg-secondary) 100%);
            border-left: 3px solid #b43c3c;
        }

        .comparison-subcategory .comparison-item {
            margin-bottom: 0.4rem;
            padding: 0.6rem 0.8rem;
        }

        .selected-users-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-color);
        }

        .selected-user-badge {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: var(--accent-gold);
            color: var(--bg-primary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .selected-user-badge .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .selected-user-badge .remove:hover {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .equipment-row {
                grid-template-columns: 1fr;
            }

            .tactic-card {
                grid-template-columns: 1fr 1fr;
            }

            .flower-grid {
                grid-template-columns: 1fr;
            }

            .progress-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Summary Section */
        .summary-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-section h2 {
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.8rem;
        }

        .summary-item {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--border-color);
        }

        .summary-item .label {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .summary-item .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .summary-item .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            background: var(--bg-secondary);
        }

        .summary-item .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .summary-item .stat-value {
            font-weight: 600;
            color: var(--accent-gold);
        }

        /* Formation Counter */
        .formation-counter {
            background: linear-gradient(135deg, rgba(60, 184, 120, 0.1) 0%, var(--bg-card) 100%);
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .formation-counter .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .formation-counter .count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        .formation-counter .count span {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
        }

        /* Bulk Select Button */
        .bulk-select-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .bulk-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bulk-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .bulk-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
        }

        /* Floating Navigation */
        .floating-nav {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 999;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(201, 162, 39, 0.4);
            transition: all 0.3s ease;
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        .floating-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            display: none;
            flex-direction: column;
            gap: 0.3rem;
            min-width: 160px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .floating-menu.show {
            display: flex;
        }

        .floating-menu-item {
            background: var(--bg-input);
            border: none;
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .floating-menu-item:hover {
            background: var(--accent-gold-dim);
            color: var(--accent-gold);
        }

        /* 3-level hierarchy for comparison */
        .comparison-level-2 {
            margin-left: 1rem;
            border-left: 2px solid var(--border-color);
            padding-left: 0.5rem;
        }

        .comparison-level-3 {
            margin-left: 1rem;
            padding-left: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Ê≠¶Â∞Ü„Éá„Éº„ÇøÁÆ°ÁêÜ</h1>
        <p>„Ç≤„Éº„É†„Éá„Éº„ÇøÂÖ•Âäõ„ÉªÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
    </header>

    <main class="container">
        <!-- Progress Overview -->
        <div class="progress-overview">
            <h2>üìä ÂÖ•ÂäõÁä∂Ê≥Å</h2>
            <div class="progress-grid" id="progressGrid">
                <div class="progress-item empty" data-section="basic">
                    <div class="label">Âü∫Á§é„Éá„Éº„Çø</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="weapon">
                    <div class="label">ÂÖµÂô®</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="spGeneral">
                    <div class="label">SPÊ≠¶Â∞Ü</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="general">
                    <div class="label">Ê≠¶Â∞Ü</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="academy">
                    <div class="label">ËªçÂ≠¶ÈÅìÂ†¥</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="asura">
                    <div class="label">Èòø‰øÆÁæÖ</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="armor">
                    <div class="label">Ê†∏ÂøÉÂÖ∑Ë∂≥</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="flower">
                    <div class="label">Ëä±Èô£</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="horse">
                    <div class="label">ËªçÈ¶¨</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
                <div class="progress-item empty" data-section="tactic">
                    <div class="label">Êà¶Ê≥ï</div>
                    <div class="status">Êú™ÂÖ•Âäõ</div>
                </div>
            </div>
        </div>

        <!-- Basic Data Section -->
        <div class="section" id="basicSection">
            <div class="section-header" onclick="toggleSection('basicSection')">
                <h3>
                    <span>üìã</span>
                    Âü∫Á§é„Éá„Éº„Çø
                    <span class="status-badge" id="basicStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>„É¶„Éº„Ç∂„ÉºÂêç *</label>
                        <input type="text" id="username" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ" onchange="updateProgress()">
                    </div>
                    <div class="form-group">
                        <label>ÂÖµÁ®Æ *</label>
                        <select id="troopType" onchange="updateProgress()">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="horse">È¶¨</option>
                            <option value="infantry">Ê≠©</option>
                            <option value="bow">Âºì</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weapon Section -->
        <div class="section" id="weaponSection">
            <div class="section-header" onclick="toggleSection('weaponSection')">
                <h3>
                    <span>‚öîÔ∏è</span>
                    ‚ë† ÂÖµÂô®
                    <span class="status-badge" id="weaponStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <!-- Bulk Select -->
                <div class="bulk-select-bar">
                    <button class="bulk-btn" onclick="bulkSelectWeapons('owned')">ÂÖ®„Å¶ÊâÄÊåÅON</button>
                    <button class="bulk-btn" onclick="bulkSelectWeapons('clear')">„ÇØ„É™„Ç¢</button>
                </div>

                <div class="equipment-card">
                    <h4>Ëµ§È¨º</h4>
                    <div class="equipment-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <select id="akoniStatus" onchange="updateProgress()">
                                <option value="">Êú™ÊâÄÊåÅ</option>
                                <option value="owned">ÊâÄÊåÅ</option>
                                <option value="equipped">Ë£ÖÂÇô‰∏≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÊòáÁ¥ö„É¨„Éô„É´</label>
                            <input type="number" id="akoniUpgrade" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÊîπË£Ö„É¨„Éô„É´</label>
                            <input type="number" id="akoniReform" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>ÈöïÁü≥</h4>
                    <div class="equipment-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <select id="insekiStatus" onchange="updateProgress()">
                                <option value="">Êú™ÊâÄÊåÅ</option>
                                <option value="owned">ÊâÄÊåÅ</option>
                                <option value="equipped">Ë£ÖÂÇô‰∏≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÊòáÁ¥ö„É¨„Éô„É´</label>
                            <input type="number" id="insekiUpgrade" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÊîπË£Ö„É¨„Éô„É´</label>
                            <input type="number" id="insekiReform" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>Ëà¨Ëã•</h4>
                    <div class="equipment-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <select id="hanyaStatus" onchange="updateProgress()">
                                <option value="">Êú™ÊâÄÊåÅ</option>
                                <option value="owned">ÊâÄÊåÅ</option>
                                <option value="equipped">Ë£ÖÂÇô‰∏≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÊòáÁ¥ö„É¨„Éô„É´</label>
                            <input type="number" id="hanyaUpgrade" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÊîπË£Ö„É¨„Éô„É´</label>
                            <input type="number" id="hanyaReform" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SP General Section -->
        <div class="section" id="spGeneralSection">
            <div class="section-header" onclick="toggleSection('spGeneralSection')">
                <h3>
                    <span>üëë</span>
                    ‚ë°-1 SPÊ≠¶Â∞Ü
                    <span class="status-badge" id="spGeneralStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <!-- Formation Counter -->
                <div class="formation-counter">
                    <span class="label">üë• Á∑®Êàê‰∏≠Ê≠¶Â∞ÜÊï∞ÔºàSPÊ≠¶Â∞ÜÔºãÊ≠¶Â∞ÜÔºâ</span>
                    <span class="count" id="totalFormationCount">0<span>‰∫∫</span></span>
                </div>

                <div class="sp-card">
                    <h4>SPÁπîÁî∞‰ø°Èï∑</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="nobunagaFormed" onchange="updateProgress()">
                                    <label for="nobunagaFormed">Á∑®ÊàêÊ∏à</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="nobunagaOwned" onchange="updateProgress()">
                                    <label for="nobunagaOwned">ÊâÄÊåÅ</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ë∂≥Ë∑°„É¨„Éô„É´</label>
                            <input type="text" id="nobunagaFootprint" placeholder="„É¨„Éô„É´„ÇíÂÖ•Âäõ" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÂâØÂ∞ÜÂêç</label>
                            <input type="text" id="nobunagaDeputy" placeholder="ÂâØÂ∞Ü„ÅÆÂêçÂâç" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="sp-card">
                    <h4>SPË±äËá£ÁßÄÂêâ</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hideyoshiFormed" onchange="updateProgress()">
                                    <label for="hideyoshiFormed">Á∑®ÊàêÊ∏à</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hideyoshiOwned" onchange="updateProgress()">
                                    <label for="hideyoshiOwned">ÊâÄÊåÅ</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ë∂≥Ë∑°„É¨„Éô„É´</label>
                            <input type="text" id="hideyoshiFootprint" placeholder="„É¨„Éô„É´„ÇíÂÖ•Âäõ" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÂâØÂ∞ÜÂêç</label>
                            <input type="text" id="hideyoshiDeputy" placeholder="ÂâØÂ∞Ü„ÅÆÂêçÂâç" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="sp-card">
                    <h4>SPÂæ≥Â∑ùÂÆ∂Â∫∑</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Áä∂ÊÖã</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ieyasuFormed" onchange="updateProgress()">
                                    <label for="ieyasuFormed">Á∑®ÊàêÊ∏à</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ieyasuOwned" onchange="updateProgress()">
                                    <label for="ieyasuOwned">ÊâÄÊåÅ</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ë∂≥Ë∑°„É¨„Éô„É´</label>
                            <input type="text" id="ieyasuFootprint" placeholder="„É¨„Éô„É´„ÇíÂÖ•Âäõ" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÂâØÂ∞ÜÂêç</label>
                            <input type="text" id="ieyasuDeputy" placeholder="ÂâØÂ∞Ü„ÅÆÂêçÂâç" onchange="updateProgress()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Section -->
        <div class="section" id="generalSection">
            <div class="section-header" onclick="toggleSection('generalSection')">
                <h3>
                    <span>üéñÔ∏è</span>
                    ‚ë°-2 Ê≠¶Â∞Ü
                    <span class="status-badge" id="generalStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    ÂêÑÊ≠¶Â∞Ü„ÅÆË¶öÈÜí„É¨„Éô„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà0„Äú12„ÄÅ„Éá„Éï„Ç©„É´„Éà: 10Ôºâ<br>
                    <span style="color: var(--accent-gold); font-size: 0.8rem;">
                        üí° Êìç‰ΩúÊñπÊ≥ïÔºöÊ≠¶Â∞ÜÂêç„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÁä∂ÊÖãÂàáÊõø ‚Üí 1ÂõûÁõÆ:ÊâÄÊåÅ / 2ÂõûÁõÆ:Á∑®Êàê / 3ÂõûÁõÆ:„Å™„Åó
                    </span>
                </p>

                <!-- Bulk Select Buttons -->
                <div class="bulk-select-bar">
                    <button class="bulk-btn" onclick="bulkSelectGenerals('all', 'owned')">ÂÖ®Âì°ÊâÄÊåÅON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('all', 'clear')">ÂÖ®Âì°„ÇØ„É™„Ç¢</button>
                    <span style="color: var(--text-muted); font-size: 0.75rem; padding: 0.4rem;">|</span>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('want', 'owned')">Ê¨≤„Åó„ÅÑÊ≠¶Â∞ÜON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('gather', 'owned')">ÈõÜÁµêÊ≠¶Â∞ÜON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('alltype', 'owned')">ÂÖ®ÂÖµÁ®ÆON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('horse', 'owned')">È¶¨Áî®ON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('infantry', 'owned')">Ê≠©Áî®ON</button>
                    <button class="bulk-btn" onclick="bulkSelectGenerals('bow', 'owned')">ÂºìÁî®ON</button>
                </div>

                <div class="general-list">
                    <h4>Á∑®ÊàêÊ≠¶Â∞Ü„É™„Çπ„Éà</h4>
                    <div class="general-categories" id="generalGrid">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <div class="custom-general">
                    <h5>„É™„Çπ„ÉàÂ§ñ„ÅÆÊ≠¶Â∞Ü„ÇíËøΩÂä†ÔºàÂÖ®„É¶„Éº„Ç∂„ÉºÂÖ±ÈÄöÔºâ</h5>
                    <div id="customGenerals">
                        <div class="custom-general-row">
                            <input type="text" placeholder="Ê≠¶Â∞ÜÂêç" class="customGeneralName">
                            <input type="number" placeholder="Ë¶öÈÜíLv" min="0" max="12" value="10" class="customGeneralLevel">
                            <button onclick="addCustomGeneral()">„É™„Çπ„Éà„Å´ËøΩÂä†</button>
                        </div>
                    </div>
                    <div id="customGeneralsList" style="margin-top: 0.8rem; display: none;">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">ËøΩÂä†Ê∏à„ÅøÊ≠¶Â∞Ü:</p>
                        <div id="customGeneralsDisplay" style="display: flex; flex-wrap: wrap; gap: 0.4rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Academy Section -->
        <div class="section" id="academySection">
            <div class="section-header" onclick="toggleSection('academySection')">
                <h3>
                    <span>üìö</span>
                    ‚ë¢ ËªçÂ≠¶ÈÅìÂ†¥
                    <span class="status-badge" id="academyStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="equipment-card">
                    <h4>Ê•µ‰ºù„É¨„Éô„É´</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ââ£</label>
                            <input type="number" id="gokudenSword" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>‰Ωì</label>
                            <input type="number" id="gokudenBody" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÊäÄ</label>
                            <input type="number" id="gokudenTech" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÂøÉÔºë</label>
                            <input type="number" id="gokudenHeart1" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÂøÉÔºí</label>
                            <input type="number" id="gokudenHeart2" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>Ê•µ‰ºùÂÖµÊ≥ï</h4>
                    <!-- Bulk Select -->
                    <div class="bulk-select-bar" style="margin-bottom: 0.8rem;">
                        <button class="bulk-btn" onclick="bulkSelectAcademy('owned')">ÂÖ®„Å¶ÊâÄÊåÅON</button>
                        <button class="bulk-btn" onclick="bulkSelectAcademy('clear')">„ÇØ„É™„Ç¢</button>
                    </div>
                    <div class="flower-grid">
                        <div class="flower-item">
                            <div class="name">Á¥ÖËëâ</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenMomiji_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenMomiji_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">Áõ§Áü≥</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenBanseki_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenBanseki_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÁçÖÂ≠ê„ÅÆÊ¥ûÂÖ•„Çä</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenShishi_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenShishi_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">Â§©ÁãóÊäÑ</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenTengu_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenTengu_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÊîªÊíÉ</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenAttack_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenAttack_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">Èò≤Âæ°</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenDefense_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenDefense_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÈÄ£ÊíÉ</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenCombo_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenCombo_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÊäµÊäó</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenResist_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenResist_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">Ê•ØÁ™Å</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenShield_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenShield_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">Ë≤´ÈÄö</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenPierce_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenPierce_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÂõûÈÅø</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenEvade_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenEvade_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÂëΩ‰∏≠</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenAccuracy_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenAccuracy_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div class="name">ÈöúÂ£Å</div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="gokudenBarrier_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="gokudenBarrier_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Asura Section -->
        <div class="section" id="asuraSection">
            <div class="section-header" onclick="toggleSection('asuraSection')">
                <h3>
                    <span>üëπ</span>
                    ‚ë£ Èòø‰øÆÁæÖ
                    <span class="status-badge" id="asuraStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="equipment-card">
                    <h4>30„É¨„Éô„É´„Çπ„Ç≠„É´</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>„Çπ„Ç≠„É´„É¨„Éô„É´Ôºà„Éá„Éï„Ç©„É´„Éà: 10Ôºâ</label>
                            <input type="number" id="asura30Level" min="1" value="10" onchange="updateProgress()">
                        </div>
                    </div>
                    <div class="skill-grid" style="margin-top: 0.8rem;">
                        <div class="skill-item">
                            <input type="checkbox" id="asura30_1" onchange="updateProgress()">
                            <label for="asura30_1">ÂéÑÊÜë</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura30_2" onchange="updateProgress()">
                            <label for="asura30_2">ÈáëÂâõ„ÅÆÈéß</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura30_3" onchange="updateProgress()">
                            <label for="asura30_3">Á®≤Áî∞Â∑°Á§º</label>
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>60„É¨„Éô„É´„Çπ„Ç≠„É´</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>„Çπ„Ç≠„É´„É¨„Éô„É´Ôºà„Éá„Éï„Ç©„É´„Éà: 10Ôºâ</label>
                            <input type="number" id="asura60Level" min="1" value="10" onchange="updateProgress()">
                        </div>
                    </div>
                    <div class="skill-grid" style="margin-top: 0.8rem;">
                        <div class="skill-item">
                            <input type="checkbox" id="asura60_1" onchange="updateProgress()">
                            <label for="asura60_1">ÁßªËä±Êé•Êú®</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura60_2" onchange="updateProgress()">
                            <label for="asura60_2">ÊîªÂÆàËª¢Êèõ</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura60_3" onchange="updateProgress()">
                            <label for="asura60_3">È¢®Âä©ÁÅ´Âã¢</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura60_4" onchange="updateProgress()">
                            <label for="asura60_4">‰øäÊïèÁã°Áåæ</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura60_5" onchange="updateProgress()">
                            <label for="asura60_5">ÂÆàÊîªËª¢Êèõ</label>
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>90„É¨„Éô„É´„Çπ„Ç≠„É´</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>„Çπ„Ç≠„É´„É¨„Éô„É´Ôºà„Éá„Éï„Ç©„É´„Éà: 10Ôºâ</label>
                            <input type="number" id="asura90Level" min="1" value="10" onchange="updateProgress()">
                        </div>
                    </div>
                    <div class="skill-grid" style="margin-top: 0.8rem;">
                        <div class="skill-item">
                            <input type="checkbox" id="asura90_1" onchange="updateProgress()">
                            <label for="asura90_1">Á†¥ÂøÉÊñ≠È™®</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura90_2" onchange="updateProgress()">
                            <label for="asura90_2">ÈÅ©ÊôÇÂá∫ÊíÉ</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura90_3" onchange="updateProgress()">
                            <label for="asura90_3">È∫íÈ∫ü„ÅÆÊ∏Ö„ÇÅ</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura90_4" onchange="updateProgress()">
                            <label for="asura90_4">Èö†ÂàÉ</label>
                        </div>
                        <div class="skill-item">
                            <input type="checkbox" id="asura90_5" onchange="updateProgress()">
                            <label for="asura90_5">Ë°ÄÊàÆ</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Armor Section -->
        <div class="section" id="armorSection">
            <div class="section-header" onclick="toggleSection('armorSection')">
                <h3>
                    <span>üõ°Ô∏è</span>
                    ‚ë§ Ê†∏ÂøÉÂÖ∑Ë∂≥
                    <span class="status-badge" id="armorStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Âë®Ëæ∫ÂÖ∑Ë∂≥ÂêàË®à„É¨„Éô„É´Ôºà„Éá„Éï„Ç©„É´„Éà: 80Ôºâ</label>
                        <input type="number" id="armorTotalLevel" min="0" value="80" onchange="updateProgress()">
                    </div>
                </div>

                <div class="equipment-card" style="margin-top: 1rem;">
                    <h4>Ê†∏ÂøÉÂÖ∑Ë∂≥Ôºà„ÅäÈù¢Ôºâ</h4>
                    <!-- Bulk Select -->
                    <div class="bulk-select-bar" style="margin-bottom: 0.8rem;">
                        <button class="bulk-btn" onclick="bulkSelectMasks('owned')">ÂÖ®„Å¶ÊâÄÊåÅON</button>
                        <button class="bulk-btn" onclick="bulkSelectMasks('clear')">„ÇØ„É™„Ç¢</button>
                    </div>
                    <div class="flower-grid">
                        <div class="flower-item">
                            <div>
                                <div class="name">ÁéÑÁãêÁ•û‰Ωø</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_genko_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_genko_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div>
                                <div class="name">ÈáëÈ∫íÈ∫ü</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_kirin_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_kirin_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div>
                                <div class="name">ÈúäÊ£ò</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_reikyo_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_reikyo_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div>
                                <div class="name">ÈáëÁåø</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_kinen_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_kinen_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div>
                                <div class="name">Ëà¨Ëã•</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_hanya_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_hanya_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                        <div class="flower-item">
                            <div>
                                <div class="name">È¨ºÁéã</div>
                            </div>
                            <div class="checkboxes">
                                <label><input type="checkbox" id="mask_kiou_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                                <label><input type="checkbox" id="mask_kiou_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flower Formation Section -->
        <div class="section" id="flowerSection">
            <div class="section-header" onclick="toggleSection('flowerSection')">
                <h3>
                    <span>üå∏</span>
                    ‚ë• Ëä±Èô£
                    <span class="status-badge" id="flowerStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <!-- Bulk Select -->
                <div class="bulk-select-bar">
                    <button class="bulk-btn" onclick="bulkSelectFlowers('owned')">ÂÖ®„Å¶ÊâÄÊåÅON</button>
                    <button class="bulk-btn" onclick="bulkSelectFlowers('clear')">„ÇØ„É™„Ç¢</button>
                </div>
                <div class="flower-grid" id="flowerGrid">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Horse Section -->
        <div class="section" id="horseSection">
            <div class="section-header" onclick="toggleSection('horseSection')">
                <h3>
                    <span>üê¥</span>
                    ‚ë¶ ËªçÈ¶¨
                    <span class="status-badge" id="horseStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div class="equipment-card">
                    <h4>Èßí„ÉªÂä†Ë≠∑Ôºà„ÉÄ„É°„Éº„Ç∏Ê∏õÔºâ</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Èáë„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_kago_gold" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÈäÄ„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_kago_silver" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>Èßí„ÉªÈºìËàûÔºà„ÉÄ„É°„Éº„Ç∏Â¢óÔºâ</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Èáë„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_kobu_gold" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÈäÄ„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_kobu_silver" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>

                <div class="equipment-card">
                    <h4>Èßí„ÉªÂèçÊíÉÔºà„ÉÄ„É°„Éº„Ç∏Ë∑≥„Å≠Ëøî„ÅóÔºâ</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Èáë„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_hangeki_gold" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                        <div class="form-group">
                            <label>ÈäÄ„Çπ„Ç≠„É´Êï∞</label>
                            <input type="number" id="horse_hangeki_silver" min="0" placeholder="0" onchange="updateProgress()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tactic Section -->
        <div class="section" id="tacticSection">
            <div class="section-header" onclick="toggleSection('tacticSection')">
                <h3>
                    <span>üìú</span>
                    ‚ëß Êà¶Ê≥ï
                    <span class="status-badge" id="tacticStatus">Êú™ÂÖ•Âäõ</span>
                </h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="section-content" id="tacticContent">
                <!-- Bulk Select (will be added by JS before tactic cards) -->
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <button class="submit-btn" onclick="submitData()">„Éá„Éº„Çø„Çí‰øùÂ≠ò</button>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2>üìà ÂÖ•Âäõ„Çµ„Éû„É™„Éº</h2>
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-item" style="border-left-color: #b85040;">
                    <span class="label">‚ë† ÂÖµÂô®</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_weapon_equipped">0/3</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_weapon_total">0/3</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: var(--accent-gold);">
                    <span class="label">‚ë°-1 SPÊ≠¶Â∞Ü</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Á∑®Êàê</span>
                            <span class="stat-value" id="summary_sp_equipped">0/3</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Á∑®Êàê</span>
                            <span class="stat-value" id="summary_sp_total">0/3</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #64a064;">
                    <span class="label">‚ë°-2 Ê≠¶Â∞Ü</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Á∑®Êàê</span>
                            <span class="stat-value" id="summary_general_equipped">0/0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Á∑®Êàê</span>
                            <span class="stat-value" id="summary_general_total">0/0</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #508cb4;">
                    <span class="label">‚ë¢ Ê•µ‰ºùÂÖµÊ≥ï</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_academy_equipped">0/13</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_academy_total">0/13</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #b43c3c;">
                    <span class="label">‚ë£ Èòø‰øÆÁæÖ</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_asura_equipped">0/13</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #8c64b4;">
                    <span class="label">‚ë§ Ê†∏ÂøÉÂÖ∑Ë∂≥</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_mask_equipped">0/6</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_mask_total">0/6</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #dc78a0;">
                    <span class="label">‚ë• Ëä±Èô£</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_flower_equipped">0/32</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_flower_total">0/32</span>
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-left-color: #3c8cb8;">
                    <span class="label">‚ëß Êà¶Ê≥ï</span>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_tactic_equipped">0/6</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ÊâÄÊåÅ+Ë£ÖÂÇô</span>
                            <span class="stat-value" id="summary_tactic_total">0/6</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div class="admin-section" id="adminSection">
            <div class="admin-header" onclick="toggleAdmin()">
                <h3>
                    <span>üîê</span>
                    ÁÆ°ÁêÜËÄÖ„Ç®„É™„Ç¢
                </h3>
                <span class="toggle-icon" id="adminToggle">‚ñº</span>
            </div>
            <div class="admin-password" id="adminPassword" style="display: none;">
                <input type="password" id="adminPwd" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                <button onclick="verifyPassword()">„É≠„Ç∞„Ç§„É≥</button>
                <button onclick="showPasswordChangeDialog()" style="margin-left: 10px; background: var(--accent-blue);">üîë „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</button>
            </div>

            <!-- Password Change Dialog -->
            <div id="passwordChangeDialog" style="display: none; padding: 1rem; background: var(--bg-input); border-radius: 8px; margin-top: 0.5rem;">
                <h4 style="color: var(--accent-gold); margin-bottom: 1rem;">ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <input type="password" id="masterPwd" placeholder="‰∏ªÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                    <input type="password" id="newAdminPwd" placeholder="Êñ∞„Åó„ÅÑÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                    <input type="password" id="confirmAdminPwd" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button onclick="changeAdminPassword()" style="flex: 1; padding: 0.5rem; background: var(--accent-green); border: none; border-radius: 4px; color: white; cursor: pointer;">Â§âÊõ¥</button>
                        <button onclick="hidePasswordChangeDialog()" style="flex: 1; padding: 0.5rem; background: var(--text-muted); border: none; border-radius: 4px; color: white; cursor: pointer;">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>
            </div>
            <div class="admin-content" id="adminContent">
                <div class="admin-actions">
                    <button class="admin-btn primary" onclick="exportAllData()">üì§ ÂÖ®„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="admin-btn" onclick="document.getElementById('importFile').click()">üì• „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="admin-btn" onclick="migrateFromLocalStorage()" style="background: var(--accent-blue);">üîÑ LocalStorage„Åã„ÇâÁßªË°å</button>
                    <button class="admin-btn danger" onclick="clearAllData()">üóëÔ∏è ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
                </div>

                <h4 style="color: var(--accent-gold); margin-bottom: 1rem;">‰øùÂ≠òÊ∏à„Åø„Éá„Éº„Çø‰∏ÄË¶ß</h4>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>„É¶„Éº„Ç∂„ÉºÂêç</th>
                                <th>ÂÖµÁ®Æ</th>
                                <th>Êõ¥Êñ∞Êó•ÊôÇ</th>
                                <th>ÂÆåÊàêÂ∫¶</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Comparison Section -->
                <div class="comparison-section">
                    <h4>üìä „É¶„Éº„Ç∂„ÉºÊØîËºÉÂàÜÊûê</h4>
                    
                    <div class="user-selector">
                        <h5>ÊØîËºÉ„Åô„Çã„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏ÊäûÔºàÊúÄÂ§ß10‰∫∫Ôºâ</h5>
                        <div class="user-checkbox-grid" id="userCheckboxGrid">
                            <!-- Populated by JS -->
                        </div>
                        <div class="selected-users-display" id="selectedUsersDisplay">
                            <!-- Selected users shown here -->
                        </div>
                        <button class="compare-btn" id="compareBtn" onclick="runComparison()" disabled>ÊØîËºÉÂàÜÊûê„ÇíÂÆüË°å</button>
                    </div>

                    <div class="comparison-results" id="comparisonResults">
                        <!-- Overlap Section -->
                        <div class="comparison-category" id="overlapCategory">
                            <div class="comparison-category-header overlap" onclick="toggleComparisonCategory('overlapCategory')">
                                <h5>
                                    <span>üìã</span>
                                    Á∑®Êàê/Ë£ÖÂÇô‰∏≠„ÅÆÈ†ÖÁõÆ
                                    <span class="count" id="overlapCount">0‰ª∂</span>
                                </h5>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="comparison-category-content" id="overlapContent">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Unused Section -->
                        <div class="comparison-category" id="unusedCategory">
                            <div class="comparison-category-header unused" onclick="toggleComparisonCategory('unusedCategory')">
                                <h5>
                                    <span>‚ùì</span>
                                    Ë™∞„ÇÇË£ÖÂÇô„Åó„Å¶„ÅÑ„Å™„ÅÑÈ†ÖÁõÆ
                                    <span class="count" id="unusedCount">0‰ª∂</span>
                                </h5>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="comparison-category-content" id="unusedContent">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Inconsistent Section -->
                        <div class="comparison-category" id="inconsistentCategory">
                            <div class="comparison-category-header inconsistent" onclick="toggleComparisonCategory('inconsistentCategory')">
                                <h5>
                                    <span>üì¶</span>
                                    ÊâÄÊåÅ„Åó„Å¶„ÅÑ„Çã„ÅåÊú™Ë£ÖÂÇô„ÅÆÈ†ÖÁõÆ
                                    <span class="count" id="inconsistentCount">0‰ª∂</span>
                                </h5>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="comparison-category-content" id="inconsistentContent">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Navigation -->
    <div class="floating-nav">
        <div class="floating-menu" id="floatingMenu">
            <button class="floating-menu-item" onclick="scrollToSection('weaponSection')">‚ë† ÂÖµÂô®</button>
            <button class="floating-menu-item" onclick="scrollToSection('spGeneralSection')">‚ë°-1 SPÊ≠¶Â∞Ü</button>
            <button class="floating-menu-item" onclick="scrollToSection('generalSection')">‚ë°-2 Ê≠¶Â∞Ü</button>
            <button class="floating-menu-item" onclick="scrollToSection('academySection')">‚ë¢ ËªçÂ≠¶ÈÅìÂ†¥</button>
            <button class="floating-menu-item" onclick="scrollToSection('asuraSection')">‚ë£ Èòø‰øÆÁæÖ</button>
            <button class="floating-menu-item" onclick="scrollToSection('armorSection')">‚ë§ Ê†∏ÂøÉÂÖ∑Ë∂≥</button>
            <button class="floating-menu-item" onclick="scrollToSection('flowerSection')">‚ë• Ëä±Èô£</button>
            <button class="floating-menu-item" onclick="scrollToSection('horseSection')">‚ë¶ ËªçÈ¶¨</button>
            <button class="floating-menu-item" onclick="scrollToSection('tacticSection')">‚ëß Êà¶Ê≥ï</button>
        </div>
        <button class="floating-btn" onclick="toggleFloatingMenu()">‚ò∞</button>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDu9WB_iA_2i5qL4uir8g__LmfAFTeuOYI",
            authDomain: "game-data-manager-6f18b.firebaseapp.com",
            databaseURL: "https://game-data-manager-6f18b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-data-manager-6f18b",
            storageBucket: "game-data-manager-6f18b.firebasestorage.app",
            messagingSenderId: "528465841462",
            appId: "1:528465841462:web:3262de1288dfb1326b3797"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            onValue,
            remove
        };

        // Signal that Firebase is ready
        window.firebaseReady = true;
        document.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script>
        // Configuration
        const MASTER_PASSWORD = 'master2024'; // ‰∏ªÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÔºà„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥Áî®Ôºâ
        let ADMIN_PASSWORD = 'admin123'; // ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„ÉâÔºàFirebase„Åã„ÇâË™≠„ÅøËæº„ÅøÂèØËÉΩÔºâ

        // Flower formations data
        const flowerFormations = [
            { id: 'higanbana', name: 'ÂΩºÂ≤∏Ëä±', effect: 'ÊîªÊíÉUP' },
            { id: 'sekichiku', name: 'Áü≥Á´π', effect: 'Ë≤´ÈÄöUP' },
            { id: 'kikyo', name: 'Ê°îÊ¢ó', effect: 'ÈÄ£ÊíÉUP' },
            { id: 'shobu', name: 'ËèñËí≤', effect: 'ÈöúÂ£ÅUP' },
            { id: 'nozen', name: 'ÂáåÈúÑ', effect: 'ÈöúÂ£ÅDown' },
            { id: 'oniyuri', name: 'È¨ºÁôæÂêà', effect: 'ÊîªÊíÉDown' },
            { id: 'matsuyoi', name: 'ÂæÖÂÆµ', effect: 'ÊäµÊäóUP' },
            { id: 'koho', name: 'È¶ôËí≤', effect: 'ÈÄ£ÊíÉUP' },
            { id: 'tsubaki', name: 'Ê§ø', effect: 'ÂÖµÂõûÂæ©' },
            { id: 'hakubai', name: 'ÁôΩÊ¢Ö', effect: 'Èò≤Âæ°UP' },
            { id: 'bara', name: 'ËñîËñá', effect: 'ÊäµÊäóDown' },
            { id: 'hagi', name: 'Ëê©', effect: 'Ë≤´ÈÄöDown' },
            { id: 'suzuran', name: 'Èà¥Ëò≠', effect: 'Èò≤Âæ°Down' },
            { id: 'sekko', name: 'Èõ™ÂÖâ', effect: 'Èò≤Âæ°‚ÜíÊîªÊíÉËª¢Êèõ' },
            { id: 'yugao', name: 'Â§ïÈ°î', effect: 'ÊîªÊíÉ‚ÜíÈò≤Âæ°Ëª¢Êèõ' },
            { id: 'asagao', name: 'ÊúùÈ°î', effect: 'ÊäµÊäó‚ÜíÈÄ£ÊíÉËª¢Êèõ' },
            { id: 'maizuru', name: 'ËàûÈ∂¥', effect: 'ÈÄ£ÊíÉ‚ÜíÊäµÊäóËª¢Êèõ' },
            { id: 'nemu', name: 'ÂêàÊ≠ì', effect: 'Ë≤´ÈÄö‚ÜíÊ•ØÁ™ÅËª¢Êèõ' },
            { id: 'ryuga', name: 'ÈæçÁâô', effect: 'Ê•ØÁ™Å‚ÜíË≤´ÈÄöËª¢Êèõ' },
            { id: 'tensei', name: 'Â§©Êòü', effect: 'ÊîªÊíÉËª¢Êèõ' },
            { id: 'rindo', name: 'Á´úËÉÜ', effect: 'Èò≤Âæ°Ëª¢Êèõ' },
            { id: 'tona', name: 'ÂçÅËèú', effect: 'ÂëΩ‰∏≠UP' },
            { id: 'akashi', name: 'ÊòéÁü≥', effect: 'ÂõûÈÅøUP' },
            { id: 'toyo', name: 'Ê°ÉÂ§≠', effect: 'ÂõûÈÅøDown' },
            { id: 'mandara', name: 'ÊõºËçºÁæÖ', effect: 'Ë≤´ÈÄöUP' },
            { id: 'udonge', name: 'ÂÑ™ÊõáËèØ', effect: 'Ê•ØÁ™ÅUP' },
            { id: 'yaezakura', name: 'ÂÖ´ÈáçÊ°ú', effect: 'Ë≤´ÈÄöËª¢Êèõ' },
            { id: 'suisen', name: 'Ê∞¥‰ªô', effect: 'Ê•ØÁ™ÅÂ§âÊèõ' },
            { id: 'kocho', name: 'ËÉ°Ëù∂', effect: 'Ë≤´ÈÄöUP' },
            { id: 'kaigyo', name: 'Êµ∑Ê•≠', effect: 'Ë≤´ÈÄöUP' },
            { id: 'shakuyaku', name: 'ËäçËñ¨', effect: 'Ë≤´ÈÄöUP' },
            { id: 'washio', name: 'È∑≤Â∞æ', effect: 'ÊäµÊäóDown' }
        ];

        // Tactics data
        const tactics = [
            { id: 'tsurinobuse', name: 'Èá£„ÇäÈáé‰ºè' },
            { id: 'kagemusha', name: 'ÂΩ±Ê≠¶ËÄÖ' },
            { id: 'kibateppo', name: 'È®éÈ¶¨ÈâÑÁ†≤' },
            { id: 'kitsutsuki', name: 'ÂïÑÊú®È≥•' },
            { id: 'kurumagai', name: 'ËªäÊá∏„Çä' },
            { id: 'sandanuchi', name: '‰∏âÊÆµÊâì„Å°' }
        ];

        // General list with categories
        const generalCategories = [
            {
                title: '„Åì„ÅÆËæ∫„ÅØ‰∏Ä‰∫∫„ÅØÊ¨≤„Åó„ÅÑÊ≠¶Â∞Ü',
                generals: ['Èà¥Êú®ÈáçÁßÄ', 'ÂØøÊ°ÇÂ∞º', '„Åä„Å§„ÇÑ„ÅÆÊñπ', 'ÈçãÂ≥∂Áõ¥ËåÇ', 'Âä†Ëó§Ê∏ÖÊ≠£', 'ÂêâÂ∑ùÂ∫ÉÂÆ∂', 'Âä†Ëó§ÂòâÊòé', 'Ë∂≥Âà©Áæ©Êò≠', 'ÁúüÊüÑÁõ¥ÈöÜ', 'Âä†Ëó§ÊÆµËîµ', 'Â±±ÂÜÖ‰∏ÄË±ä']
            },
            {
                title: 'ÈõÜÁµê„Åß‰Ωø„ÅÜÊ≠¶Â∞Ü',
                generals: ['ÂåóÊù°Êó©Èõ≤', 'ÁπîÁî∞‰ø°Èï∑', 'Êú¨Â§öÂø†Âãù', 'ÂåóÊù°Ê∞èÂ∫∑', 'Â±±Êú¨ÂãòÂä©', 'ÊØõÂà©ÂÖÉÂ∞±', 'Â≥∂Ê¥•ÂÆ∂‰πÖ', 'Â†ÄÁßÄÊîø', 'ÁúüÁî∞Âπ∏Êùë', 'ÈªíÁî∞ÂÆòÂÖµË°õ', 'Âæ≥Â∑ùÂÆ∂Â∫∑', 'Êùë‰∫ïË≤ûÂãù', '‰∏äÊ≥â‰ø°Á∂±', 'ÁúüÁî∞Âπ∏ÈöÜ', 'Êü≥ÁîüÂÆóÂé≥', 'Â§™Áî∞ÈÅìÁÅå']
            },
            {
                title: 'ÂÖ®ÂÖµÁ®ÆÂØæÂøúÊ≠¶Â∞Ü',
                generals: ['‰∫ï‰ºäÁõ¥Ëôé', 'Ê´õÊ©ãÂÖâ', 'Áõ¥Ê±üÂÖºÁ∂ö', 'Ë±äËá£ÁßÄÂêâ', 'Â∞ºÂ≠êÁµå‰πÖ', 'Á´ãËä±ÂÆóËåÇ', 'Á∑ãÊùëÂâ£ÂøÉ', 'Á•ûË∞∑Ëñ´', 'ÂÆáÂñúÂ§öÁõ¥ÂÆ∂', '‰∫ï‰ºäÁõ¥Êîø', 'Ê£ÆÈï∑ÂèØ', 'ÊûúÂøÉÂ±ÖÂ£´', 'Ëó§Â†ÇÈ´òËôé', 'ÁßãÂ±±‰ø°Âèã', 'Ê¶äÂéüÂ∫∑Êîø', '‰∏âÊµ¶ÊåâÈáù', '‰∏äÊùâÊôØÂãù']
            },
            {
                title: 'È¶¨Áî®',
                generals: ['Ê≠¶Áî∞‰ø°ÁéÑ', '‰ºäÈÅîÊîøÂÆó', 'ÂåóÊù°Ê∞èÁ∂±', 'Â±±‰∏≠Èπø‰πã‰ªã', 'Áî≤ÊñêÂß´', 'Â±±ÁúåÊòåÊôØ', 'Áæ©Âß´', 'È´òÂùÇÊòå‰ø°', 'ÁúüÁî∞‰ø°‰πã', 'Á∂æÂæ°Ââç', 'ÊüøÂ¥éÊôØÂÆ∂', '‰Ωê„ÄÖÊàêÊîø']
            },
            {
                title: 'Ê≠©Áî®',
                generals: ['ÂÆÆÊú¨Ê≠¶Ëîµ', '„É™„É¥„Ç°„Ç§', 'Ê∑Ä', 'Â∞èÊó©Â∑ù', 'Á¥∞Â∑ùÂø†Ëàà', 'Ê≠¶Áî∞‰ø°ÁπÅ', '‰∏âÂ•ΩÈï∑ÊÖ∂', 'ÂçÉ‰ª£', 'ÂåóÊù°Á∂±Êàê', '„Å≠„Å≠', 'È´òÊ©ãÁ¥πÈÅã', 'ÊÑõÂß´', 'Á¶èÂ≥∂Ê≠£Ââá', '‰ºäÈÅîÊàêÂÆü']
            },
            {
                title: 'ÂºìÁî®',
                generals: ['ÊñéËó§Âà©‰∏â', 'Ëµ§‰∫ïÁõ¥Ê≠£', 'Âá∫Èõ≤ÈòøÂõΩ', '‰ºäÈÅîÊ§çÂÆó', 'Êò•Êó•Â±Ä', 'ÁπîÁî∞‰ø°Âø†', 'Â≥∂Ê¥•Ê≠≥‰πÖ', 'Â§©ËçâÂõõÈÉé']
            }
        ];

        // Flatten generals for backwards compatibility
        const generals = generalCategories.flatMap(cat => cat.generals);

        // Cache for data
        let cachedGameData = {};
        let cachedCustomGenerals = [];

        // ========== Firebase Database Functions ==========
        
        // Get all game data
        async function getGameData() {
            if (!window.firebaseReady) {
                return cachedGameData;
            }
            try {
                const { database, ref, get } = window.firebaseDB;
                const snapshot = await get(ref(database, 'gameData'));
                cachedGameData = snapshot.exists() ? snapshot.val() : {};
                return cachedGameData;
            } catch (error) {
                console.error('Error getting game data:', error);
                return cachedGameData;
            }
        }

        // Save user data
        async function saveUserData(username, data) {
            if (!window.firebaseReady) {
                showToast('FirebaseÊé•Á∂ö‰∏≠...', 'error');
                return false;
            }
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, `gameData/${username}`), data);
                cachedGameData[username] = data;
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                showToast('‰øùÂ≠ò„Ç®„É©„Éº: ' + error.message, 'error');
                return false;
            }
        }

        // Delete user data
        async function deleteUserData(username) {
            if (!window.firebaseReady) return false;
            try {
                const { database, ref, remove } = window.firebaseDB;
                await remove(ref(database, `gameData/${username}`));
                delete cachedGameData[username];
                return true;
            } catch (error) {
                console.error('Error deleting data:', error);
                return false;
            }
        }

        // Get custom generals
        async function getCustomGenerals() {
            if (!window.firebaseReady) {
                return cachedCustomGenerals;
            }
            try {
                const { database, ref, get } = window.firebaseDB;
                const snapshot = await get(ref(database, 'customGenerals'));
                cachedCustomGenerals = snapshot.exists() ? snapshot.val() : [];
                return cachedCustomGenerals;
            } catch (error) {
                console.error('Error getting custom generals:', error);
                return cachedCustomGenerals;
            }
        }

        // Save custom generals
        async function saveCustomGenerals(generalsList) {
            if (!window.firebaseReady) return false;
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, 'customGenerals'), generalsList);
                cachedCustomGenerals = generalsList;
                return true;
            } catch (error) {
                console.error('Error saving custom generals:', error);
                return false;
            }
        }

        // Set up real-time listeners
        function setupRealtimeListeners() {
            if (!window.firebaseReady) return;
            
            const { database, ref, onValue } = window.firebaseDB;
            
            // Listen for game data changes
            onValue(ref(database, 'gameData'), (snapshot) => {
                cachedGameData = snapshot.exists() ? snapshot.val() : {};
                refreshDataTable();
                refreshUserCheckboxGrid();
            });

            // Listen for custom generals changes
            onValue(ref(database, 'customGenerals'), (snapshot) => {
                const newGenerals = snapshot.exists() ? snapshot.val() : [];
                if (JSON.stringify(newGenerals) !== JSON.stringify(cachedCustomGenerals)) {
                    cachedCustomGenerals = newGenerals;
                    initGeneralGrid();
                    updateCustomGeneralsDisplay();
                }
            });
        }


        // ========== Initialization ==========
        
        async function initializeGameApp() {
            initFlowerGrid();
            initTacticSection();

            // Load admin password from Firebase
            await loadAdminPassword();

            // Load custom generals first
            cachedCustomGenerals = await getCustomGenerals();
            initGeneralGrid();
            updateCustomGeneralsDisplay();

            // Load game data
            cachedGameData = await getGameData();
            loadSavedData();
            
            updateProgress();
            updateSummary();
            updateFormationCount();
            
            // Setup real-time sync
            setupRealtimeListeners();
            
            showToast('„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü', 'success');
        }

        // Wait for Firebase and DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            if (window.firebaseReady) {
                initializeGameApp();
            } else {
                document.addEventListener('firebaseReady', initializeGameApp);
            }
        });

        // Initialize flower grid
        function initFlowerGrid() {
            const grid = document.getElementById('flowerGrid');
            grid.innerHTML = flowerFormations.map(f => `
                <div class="flower-item">
                    <div>
                        <div class="name">${f.name}</div>
                        <div class="effect">${f.effect}</div>
                    </div>
                    <div class="checkboxes">
                        <label><input type="checkbox" id="flower_${f.id}_equipped" onchange="updateProgress()"> Ë£ÖÂÇô</label>
                        <label><input type="checkbox" id="flower_${f.id}_owned" onchange="updateProgress()"> ÊâÄÊåÅ</label>
                    </div>
                </div>
            `).join('');
        }

        function initTacticSection() {
            const content = document.getElementById('tacticContent');
            const bulkSelectHtml = `
                <div class="bulk-select-bar">
                    <button class="bulk-btn" onclick="bulkSelectTactics('owned')">ÂÖ®„Å¶ÊâÄÊåÅON</button>
                    <button class="bulk-btn" onclick="bulkSelectTactics('clear')">„ÇØ„É™„Ç¢</button>
                </div>
            `;
            const tacticsHtml = tactics.map(t => `
                <div class="tactic-card">
                    <div class="name">${t.name}</div>
                    <div class="form-group">
                        <label>„É¨„Éô„É´</label>
                        <input type="number" id="tactic_${t.id}_level" value="80" min="1" onchange="updateProgress()">
                    </div>
                    <div class="form-group">
                        <label>ÊòáÊÆµ</label>
                        <select id="tactic_${t.id}_rank" onchange="updateProgress()">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="tactic_${t.id}_equipped" onchange="updateProgress()">
                        <label>Ë£ÖÂÇô</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="tactic_${t.id}_owned" onchange="updateProgress()">
                        <label>ÊâÄÊåÅ</label>
                    </div>
                </div>
            `).join('');
            content.innerHTML = bulkSelectHtml + tacticsHtml;
        }

        // Initialize general grid with categories
        function initGeneralGrid() {
            const grid = document.getElementById('generalGrid');
            const customGenerals = cachedCustomGenerals || [];
            
            let globalIndex = 0;
            let html = '';
            
            // Add predefined categories
            generalCategories.forEach(cat => {
                html += `
                    <div class="general-category">
                        <div class="general-category-title">‚óè${cat.title}</div>
                        <div class="general-grid">
                            ${cat.generals.map(g => {
                                const index = globalIndex++;
                                return `
                                    <div class="general-item" id="generalItem_${index}" data-general="${g}" data-state="0">
                                        <span class="general-name" onclick="toggleGeneralState(${index})">${g}</span>
                                        <span class="status-badge"></span>
                                        <input type="number" id="general_${index}" min="0" max="12" value="10" onchange="updateProgress()">
                                        <input type="hidden" id="generalState_${index}" value="0">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            // Add custom generals category if any exist
            if (customGenerals.length > 0) {
                html += `
                    <div class="general-category" id="customGeneralCategory">
                        <div class="general-category-title">‚óèËøΩÂä†Ê≠¶Â∞Ü</div>
                        <div class="general-grid" id="customGeneralGrid">
                            ${customGenerals.map(g => {
                                const index = globalIndex++;
                                return `
                                    <div class="general-item" id="generalItem_${index}" data-general="${g}" data-state="0">
                                        <span class="general-name" onclick="toggleGeneralState(${index})">${g}</span>
                                        <span class="status-badge"></span>
                                        <input type="number" id="general_${index}" min="0" max="12" value="10" onchange="updateProgress()">
                                        <input type="hidden" id="generalState_${index}" value="0">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        // Get all generals including custom ones
        function getAllGenerals() {
            return [...generals, ...(cachedCustomGenerals || [])];
        }

        // Get total general count for indexing
        function getGeneralIndex(generalName) {
            const allGenerals = getAllGenerals();
            return allGenerals.indexOf(generalName);
        }

        // Toggle general state: 0 (none) -> 1 (owned) -> 2 (formed) -> 0 (none)
        function toggleGeneralState(index) {
            const item = document.getElementById(`generalItem_${index}`);
            const hiddenInput = document.getElementById(`generalState_${index}`);
            let currentState = parseInt(item.dataset.state || '0');
            
            // Cycle through states: 0 -> 1 -> 2 -> 0
            currentState = (currentState + 1) % 3;
            
            item.dataset.state = currentState;
            hiddenInput.value = currentState;
            
            // Update visual classes
            item.classList.remove('owned', 'formed');
            if (currentState === 1) {
                item.classList.add('owned');
            } else if (currentState === 2) {
                item.classList.add('formed');
            }
            
            updateProgress();
        }

        // Legacy function for compatibility
        function toggleGeneralFormed(index) {
            toggleGeneralState(index);
        }

        // Toggle section collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }


        // ========== Data Collection ==========

        function collectFormData() {
            const data = {};
            
            // Basic info
            data.username = document.getElementById('username').value;
            data.troopType = document.getElementById('troopType').value;
            data.timestamp = new Date().toISOString();

            // Weapons
            data.weapons = {};
            ['akoni', 'inseki', 'hanya'].forEach(w => {
                data.weapons[w] = {
                    status: document.getElementById(`${w}Status`).value,
                    upgrade: document.getElementById(`${w}Upgrade`).value,
                    reform: document.getElementById(`${w}Reform`).value
                };
            });

            // SP Generals
            data.spGenerals = {};
            ['nobunaga', 'hideyoshi', 'ieyasu'].forEach(sp => {
                data.spGenerals[sp] = {
                    formed: document.getElementById(`${sp}Formed`).checked,
                    owned: document.getElementById(`${sp}Owned`).checked,
                    footprint: document.getElementById(`${sp}Footprint`).value,
                    deputy: document.getElementById(`${sp}Deputy`).value
                };
            });

            // Generals
            const allGenerals = getAllGenerals();
            data.generals = {};
            for (let i = 0; i < allGenerals.length; i++) {
                const levelEl = document.getElementById(`general_${i}`);
                const stateEl = document.getElementById(`generalState_${i}`);
                if (levelEl) {
                    const state = stateEl ? parseInt(stateEl.value) : 0;
                    data.generals[allGenerals[i]] = {
                        level: levelEl.value,
                        owned: state >= 1,
                        formed: state === 2
                    };
                }
            }

            // Academy
            const gokudenHeiho = ['Momiji', 'Banseki', 'Shishi', 'Tengu', 'Attack', 'Defense', 'Combo', 'Resist', 'Shield', 'Pierce', 'Evade', 'Accuracy', 'Barrier'];
            data.academy = {
                sword: document.getElementById('gokudenSword').value,
                body: document.getElementById('gokudenBody').value,
                tech: document.getElementById('gokudenTech').value,
                heart1: document.getElementById('gokudenHeart1').value,
                heart2: document.getElementById('gokudenHeart2').value,
                heiho: {}
            };
            gokudenHeiho.forEach(h => {
                data.academy.heiho[h.toLowerCase()] = {
                    equipped: document.getElementById(`gokuden${h}_equipped`)?.checked || false,
                    owned: document.getElementById(`gokuden${h}_owned`)?.checked || false
                };
            });

            // Asura
            data.asura = {
                level30: document.getElementById('asura30Level').value,
                level60: document.getElementById('asura60Level').value,
                level90: document.getElementById('asura90Level').value,
                skills30: [
                    document.getElementById('asura30_1').checked,
                    document.getElementById('asura30_2').checked,
                    document.getElementById('asura30_3').checked
                ],
                skills60: [
                    document.getElementById('asura60_1').checked,
                    document.getElementById('asura60_2').checked,
                    document.getElementById('asura60_3').checked,
                    document.getElementById('asura60_4').checked,
                    document.getElementById('asura60_5').checked
                ],
                skills90: [
                    document.getElementById('asura90_1').checked,
                    document.getElementById('asura90_2').checked,
                    document.getElementById('asura90_3').checked,
                    document.getElementById('asura90_4').checked,
                    document.getElementById('asura90_5').checked
                ]
            };

            // Armor
            data.armor = {
                totalLevel: document.getElementById('armorTotalLevel').value,
                masks: {}
            };
            ['genko', 'kirin', 'reikyo', 'kinen', 'hanya', 'kiou'].forEach(m => {
                data.armor.masks[m] = {
                    equipped: document.getElementById(`mask_${m}_equipped`).checked,
                    owned: document.getElementById(`mask_${m}_owned`).checked
                };
            });

            // Flowers
            data.flowers = {};
            flowerFormations.forEach(f => {
                data.flowers[f.id] = {
                    equipped: document.getElementById(`flower_${f.id}_equipped`).checked,
                    owned: document.getElementById(`flower_${f.id}_owned`).checked
                };
            });

            // Horse
            data.horse = {
                kago: {
                    gold: document.getElementById('horse_kago_gold').value,
                    silver: document.getElementById('horse_kago_silver').value
                },
                kobu: {
                    gold: document.getElementById('horse_kobu_gold').value,
                    silver: document.getElementById('horse_kobu_silver').value
                },
                hangeki: {
                    gold: document.getElementById('horse_hangeki_gold').value,
                    silver: document.getElementById('horse_hangeki_silver').value
                }
            };

            // Tactics
            data.tactics = {};
            tactics.forEach(t => {
                data.tactics[t.id] = {
                    level: document.getElementById(`tactic_${t.id}_level`).value,
                    rank: document.getElementById(`tactic_${t.id}_rank`).value,
                    equipped: document.getElementById(`tactic_${t.id}_equipped`).checked,
                    owned: document.getElementById(`tactic_${t.id}_owned`).checked
                };
            });

            return data;
        }

        // Submit data to Firebase
        async function submitData() {
            const data = collectFormData();
            
            if (!data.username) {
                showToast('„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const success = await saveUserData(data.username, data);
            
            if (success) {
                showToast(`${data.username}„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'success');
                refreshDataTable();
            }
        }

        // Load saved data for current user
        function loadSavedData() {
            const username = document.getElementById('username').value;
            if (!username) return;
            
            const data = cachedGameData[username];
            if (data) {
                loadDataToForm(data);
            }
        }


        // Load data to form
        function loadDataToForm(data) {
            if (!data) return;

            // Basic info
            if (data.username) document.getElementById('username').value = data.username;
            if (data.troopType) document.getElementById('troopType').value = data.troopType;

            // Weapons
            if (data.weapons) {
                ['akoni', 'inseki', 'hanya'].forEach(w => {
                    if (data.weapons[w]) {
                        document.getElementById(`${w}Status`).value = data.weapons[w].status || '';
                        document.getElementById(`${w}Upgrade`).value = data.weapons[w].upgrade || '';
                        document.getElementById(`${w}Reform`).value = data.weapons[w].reform || '';
                    }
                });
            }

            // SP Generals
            if (data.spGenerals) {
                ['nobunaga', 'hideyoshi', 'ieyasu'].forEach(sp => {
                    if (data.spGenerals[sp]) {
                        document.getElementById(`${sp}Formed`).checked = data.spGenerals[sp].formed || false;
                        document.getElementById(`${sp}Owned`).checked = data.spGenerals[sp].owned || false;
                        document.getElementById(`${sp}Footprint`).value = data.spGenerals[sp].footprint || '';
                        document.getElementById(`${sp}Deputy`).value = data.spGenerals[sp].deputy || '';
                    }
                });
            }

            // Generals
            if (data.generals) {
                const allGenerals = getAllGenerals();
                for (let i = 0; i < allGenerals.length; i++) {
                    const levelEl = document.getElementById(`general_${i}`);
                    const stateEl = document.getElementById(`generalState_${i}`);
                    const itemEl = document.getElementById(`generalItem_${i}`);
                    const generalData = data.generals[allGenerals[i]];
                    
                    if (levelEl && generalData) {
                        if (typeof generalData === 'object') {
                            levelEl.value = generalData.level || 10;
                            if (stateEl && itemEl) {
                                let state = 0;
                                if (generalData.formed) {
                                    state = 2;
                                } else if (generalData.owned) {
                                    state = 1;
                                }
                                stateEl.value = state;
                                itemEl.dataset.state = state;
                                
                                itemEl.classList.remove('owned', 'formed');
                                if (state === 1) {
                                    itemEl.classList.add('owned');
                                } else if (state === 2) {
                                    itemEl.classList.add('formed');
                                }
                            }
                        } else {
                            levelEl.value = generalData;
                        }
                    }
                }
            }

            // Academy
            if (data.academy) {
                document.getElementById('gokudenSword').value = data.academy.sword || '';
                document.getElementById('gokudenBody').value = data.academy.body || '';
                document.getElementById('gokudenTech').value = data.academy.tech || '';
                document.getElementById('gokudenHeart1').value = data.academy.heart1 || '';
                document.getElementById('gokudenHeart2').value = data.academy.heart2 || '';
                
                if (data.academy.heiho) {
                    const gokudenHeiho = ['Momiji', 'Banseki', 'Shishi', 'Tengu', 'Attack', 'Defense', 'Combo', 'Resist', 'Shield', 'Pierce', 'Evade', 'Accuracy', 'Barrier'];
                    gokudenHeiho.forEach(h => {
                        const hData = data.academy.heiho[h.toLowerCase()];
                        if (hData) {
                            const equippedEl = document.getElementById(`gokuden${h}_equipped`);
                            const ownedEl = document.getElementById(`gokuden${h}_owned`);
                            if (equippedEl) equippedEl.checked = hData.equipped || false;
                            if (ownedEl) ownedEl.checked = hData.owned || false;
                        }
                    });
                }
            }

            // Asura
            if (data.asura) {
                document.getElementById('asura30Level').value = data.asura.level30 || 10;
                document.getElementById('asura60Level').value = data.asura.level60 || 10;
                document.getElementById('asura90Level').value = data.asura.level90 || 10;
                
                if (data.asura.skills30) {
                    ['asura30_1', 'asura30_2', 'asura30_3'].forEach((id, i) => {
                        document.getElementById(id).checked = data.asura.skills30[i] || false;
                    });
                }
                if (data.asura.skills60) {
                    ['asura60_1', 'asura60_2', 'asura60_3', 'asura60_4', 'asura60_5'].forEach((id, i) => {
                        document.getElementById(id).checked = data.asura.skills60[i] || false;
                    });
                }
                if (data.asura.skills90) {
                    ['asura90_1', 'asura90_2', 'asura90_3', 'asura90_4', 'asura90_5'].forEach((id, i) => {
                        document.getElementById(id).checked = data.asura.skills90[i] || false;
                    });
                }
            }

            // Armor
            if (data.armor) {
                document.getElementById('armorTotalLevel').value = data.armor.totalLevel || 80;
                if (data.armor.masks) {
                    ['genko', 'kirin', 'reikyo', 'kinen', 'hanya', 'kiou'].forEach(m => {
                        if (data.armor.masks[m]) {
                            document.getElementById(`mask_${m}_equipped`).checked = data.armor.masks[m].equipped || false;
                            document.getElementById(`mask_${m}_owned`).checked = data.armor.masks[m].owned || false;
                        }
                    });
                }
            }

            // Flowers
            if (data.flowers) {
                flowerFormations.forEach(f => {
                    if (data.flowers[f.id]) {
                        document.getElementById(`flower_${f.id}_equipped`).checked = data.flowers[f.id].equipped || false;
                        document.getElementById(`flower_${f.id}_owned`).checked = data.flowers[f.id].owned || false;
                    }
                });
            }

            // Horse
            if (data.horse) {
                document.getElementById('horse_kago_gold').value = data.horse.kago?.gold || '';
                document.getElementById('horse_kago_silver').value = data.horse.kago?.silver || '';
                document.getElementById('horse_kobu_gold').value = data.horse.kobu?.gold || '';
                document.getElementById('horse_kobu_silver').value = data.horse.kobu?.silver || '';
                document.getElementById('horse_hangeki_gold').value = data.horse.hangeki?.gold || '';
                document.getElementById('horse_hangeki_silver').value = data.horse.hangeki?.silver || '';
            }

            // Tactics
            if (data.tactics) {
                tactics.forEach(t => {
                    if (data.tactics[t.id]) {
                        document.getElementById(`tactic_${t.id}_level`).value = data.tactics[t.id].level || 80;
                        document.getElementById(`tactic_${t.id}_rank`).value = data.tactics[t.id].rank || 0;
                        document.getElementById(`tactic_${t.id}_equipped`).checked = data.tactics[t.id].equipped || false;
                        document.getElementById(`tactic_${t.id}_owned`).checked = data.tactics[t.id].owned || false;
                    }
                });
            }

            updateProgress();
            updateSummary();
            updateFormationCount();
        }

        // Clear form
        function clearForm() {
            document.getElementById('username').value = '';
            document.getElementById('troopType').value = '';
            
            // Clear all inputs
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => {
                if (el.id.includes('Level') || el.id.includes('level')) {
                    el.value = el.defaultValue || 10;
                } else if (el.id === 'armorTotalLevel') {
                    el.value = 80;
                } else {
                    el.value = '';
                }
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                el.checked = false;
            });
            
            document.querySelectorAll('select').forEach(el => {
                el.selectedIndex = 0;
            });
            
            // Reset general states
            const allGenerals = getAllGenerals();
            for (let i = 0; i < allGenerals.length; i++) {
                const item = document.getElementById(`generalItem_${i}`);
                const stateEl = document.getElementById(`generalState_${i}`);
                if (item) {
                    item.classList.remove('owned', 'formed');
                    item.dataset.state = '0';
                }
                if (stateEl) stateEl.value = '0';
            }
            
            updateProgress();
            updateSummary();
            updateFormationCount();
        }


        // ========== Admin Functions ==========

        // Toggle password input visibility
        function toggleAdmin() {
            const passwordSection = document.getElementById('adminPassword');
            const toggle = document.getElementById('adminToggle');
            const isHidden = passwordSection.style.display === 'none';

            passwordSection.style.display = isHidden ? 'flex' : 'none';
            toggle.textContent = isHidden ? '‚ñ≤' : '‚ñº';

            // Hide password change dialog when closing
            if (!isHidden) {
                hidePasswordChangeDialog();
            }
        }

        // Verify admin password and show content
        function verifyPassword() {
            const password = document.getElementById('adminPwd').value;
            const content = document.getElementById('adminContent');

            if (password === ADMIN_PASSWORD) {
                content.classList.add('show');
                refreshDataTable();
                refreshUserCheckboxGrid();
                showToast('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü', 'success');
            } else {
                showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô', 'error');
            }
        }

        // Show password change dialog
        function showPasswordChangeDialog() {
            document.getElementById('passwordChangeDialog').style.display = 'block';
        }

        // Hide password change dialog
        function hidePasswordChangeDialog() {
            document.getElementById('passwordChangeDialog').style.display = 'none';
            document.getElementById('masterPwd').value = '';
            document.getElementById('newAdminPwd').value = '';
            document.getElementById('confirmAdminPwd').value = '';
        }

        // Change admin password
        async function changeAdminPassword() {
            const masterPwd = document.getElementById('masterPwd').value;
            const newPwd = document.getElementById('newAdminPwd').value;
            const confirmPwd = document.getElementById('confirmAdminPwd').value;

            // Validate master password
            if (masterPwd !== MASTER_PASSWORD) {
                showToast('‰∏ªÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô', 'error');
                return;
            }

            // Validate new password
            if (!newPwd || newPwd.length < 4) {
                showToast('Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ4ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showToast('Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }

            // Save to Firebase
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, 'settings/adminPassword'), newPwd);
                ADMIN_PASSWORD = newPwd;
                hidePasswordChangeDialog();
                showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('Password change error:', error);
                showToast('„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Load admin password from Firebase
        async function loadAdminPassword() {
            if (!window.firebaseReady) return;

            try {
                const { database, ref, get } = window.firebaseDB;
                const snapshot = await get(ref(database, 'settings/adminPassword'));
                if (snapshot.exists()) {
                    ADMIN_PASSWORD = snapshot.val();
                }
            } catch (error) {
                console.error('Failed to load admin password:', error);
            }
        }

        function refreshDataTable() {
            const tbody = document.getElementById('dataTableBody');
            const allData = cachedGameData;
            
            if (!allData || Object.keys(allData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(allData).map(([name, data]) => {
                const completion = calculateCompletion(data);
                const date = data.timestamp ? new Date(data.timestamp).toLocaleString('ja-JP') : '-';
                return `
                    <tr>
                        <td>${name}</td>
                        <td>${date}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${completion}%"></div>
                            </div>
                            <span style="font-size: 0.8rem;">${completion}%</span>
                        </td>
                        <td>
                            <button class="action-btn" onclick="editUser('${name}')">Á∑®ÈõÜ</button>
                            <button class="action-btn delete" onclick="confirmDeleteUser('${name}')">ÂâäÈô§</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateCompletion(data) {
            let filled = 0;
            let total = 0;

            // Basic fields
            total += 2;
            if (data.username) filled++;
            if (data.troopType) filled++;

            // Weapons (3 items)
            if (data.weapons) {
                Object.values(data.weapons).forEach(w => {
                    total += 3;
                    if (w.status) filled++;
                    if (w.upgrade) filled++;
                    if (w.reform) filled++;
                });
            }

            return Math.round((filled / Math.max(total, 1)) * 100);
        }

        function editUser(username) {
            const data = cachedGameData[username];
            if (data) {
                clearForm();
                loadDataToForm(data);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showToast(`${username}„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success');
            }
        }

        function confirmDeleteUser(username) {
            if (confirm(`${username}„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                deleteUser(username);
            }
        }

        async function deleteUser(username) {
            const success = await deleteUserData(username);
            if (success) {
                showToast(`${username}„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
                refreshDataTable();
                refreshUserCheckboxGrid();
            } else {
                showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(cachedGameData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `game-data-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Save each user
                        for (const [username, userData] of Object.entries(data)) {
                            await saveUserData(username, userData);
                        }
                        showToast('„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
                        refreshDataTable();
                    } catch (error) {
                        showToast('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function clearAllData() {
            if (!confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
            if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            const { database, ref, remove } = window.firebaseDB;
            try {
                await remove(ref(database, 'gameData'));
                cachedGameData = {};
                showToast('ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                refreshDataTable();
                refreshUserCheckboxGrid();
            } catch (error) {
                showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Migrate data from localStorage to Firebase
        async function migrateFromLocalStorage() {
            const localData = localStorage.getItem('gameData');

            if (!localData) {
                showToast('LocalStorage„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                const data = JSON.parse(localData);
                const userCount = Object.keys(data).length;

                if (userCount === 0) {
                    showToast('ÁßªË°å„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                    return;
                }

                if (!confirm(`LocalStorage„Åã„Çâ${userCount}‰ª∂„ÅÆ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíFirebase„Å´ÁßªË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }

                let successCount = 0;
                for (const [username, userData] of Object.entries(data)) {
                    // Ensure username is set in the data
                    userData.username = username;
                    const success = await saveUserData(username, userData);
                    if (success) successCount++;
                }

                showToast(`${successCount}/${userCount}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÁßªË°å„Åó„Åæ„Åó„Åü`, 'success');
                refreshDataTable();
                refreshUserCheckboxGrid();

                // Optionally clear localStorage after successful migration
                if (successCount === userCount && confirm('ÁßªË°åÂÆå‰∫Ü„ÄÇLocalStorage„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    localStorage.removeItem('gameData');
                    showToast('LocalStorage„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            } catch (error) {
                console.error('Migration error:', error);
                showToast('ÁßªË°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }


        // ========== Custom Generals Management ==========

        async function addCustomGeneral() {
            const container = document.getElementById('customGenerals');
            const inputs = container.querySelectorAll('.custom-general-row');
            const lastRow = inputs[inputs.length - 1];
            const nameInput = lastRow.querySelector('.customGeneralName');
            const levelInput = lastRow.querySelector('.customGeneralLevel');
            
            const generalName = nameInput.value.trim();
            
            if (!generalName) {
                showToast('Ê≠¶Â∞ÜÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            // Check if already exists
            const allGenerals = getAllGenerals();
            if (allGenerals.includes(generalName)) {
                showToast('„Åì„ÅÆÊ≠¶Â∞Ü„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'error');
                return;
            }

            // Save to Firebase
            const newList = [...cachedCustomGenerals, generalName];
            const success = await saveCustomGenerals(newList);
            
            if (success) {
                // Reinitialize the grid
                initGeneralGrid();
                
                // Clear inputs
                nameInput.value = '';
                levelInput.value = '10';

                updateCustomGeneralsDisplay();
                showToast(`${generalName}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
                updateProgress();
            }
        }

        async function removeCustomGeneral(generalName) {
            const newList = cachedCustomGenerals.filter(g => g !== generalName);
            const success = await saveCustomGenerals(newList);
            
            if (success) {
                initGeneralGrid();
                updateCustomGeneralsDisplay();
                showToast(`${generalName}„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
                updateProgress();
            }
        }

        function updateCustomGeneralsDisplay() {
            const display = document.getElementById('customGeneralsDisplay');
            const customGenerals = cachedCustomGenerals || [];
            
            if (customGenerals.length === 0) {
                display.innerHTML = '<span style="color: var(--text-muted);">ËøΩÂä†„Åï„Çå„ÅüÊ≠¶Â∞Ü„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
                return;
            }

            display.innerHTML = customGenerals.map(g => `
                <span class="custom-general-tag">
                    ${g}
                    <button onclick="removeCustomGeneral('${g}')" title="ÂâäÈô§">‚úï</button>
                </span>
            `).join('');
        }

        // ========== Progress Update ==========

        function updateProgress() {
            updateSectionStatus('basicStatus', checkBasicComplete());
            updateSectionStatus('weaponStatus', checkWeaponComplete());
            updateSectionStatus('spGeneralStatus', checkSpGeneralComplete());
            updateSectionStatus('generalStatus', checkGeneralComplete());
            updateSectionStatus('academyStatus', checkAcademyComplete());
            updateSectionStatus('asuraStatus', checkAsuraComplete());
            updateSectionStatus('armorStatus', checkArmorComplete());
            updateSectionStatus('flowerStatus', checkFlowerComplete());
            updateSectionStatus('horseStatus', checkHorseComplete());
            updateSectionStatus('tacticStatus', checkTacticComplete());
        }

        function updateSectionStatus(elementId, status) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.className = 'status-badge ' + status;
            switch(status) {
                case 'complete': el.textContent = 'ÂÆå‰∫Ü'; break;
                case 'partial': el.textContent = 'ÂÖ•Âäõ‰∏≠'; break;
                default: el.textContent = 'Êú™ÂÖ•Âäõ';
            }
        }

        function checkBasicComplete() {
            const username = document.getElementById('username').value;
            const troopType = document.getElementById('troopType').value;
            if (username && troopType) return 'complete';
            if (username || troopType) return 'partial';
            return 'empty';
        }

        function checkWeaponComplete() {
            let hasAny = false;
            ['akoni', 'inseki', 'hanya'].forEach(w => {
                if (document.getElementById(`${w}Status`).value) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkSpGeneralComplete() {
            let hasAny = false;
            ['nobunaga', 'hideyoshi', 'ieyasu'].forEach(sp => {
                if (document.getElementById(`${sp}Formed`).checked) hasAny = true;
                if (document.getElementById(`${sp}Owned`).checked) hasAny = true;
                if (document.getElementById(`${sp}Footprint`).value) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkGeneralComplete() {
            let hasAny = false;
            const allGenerals = getAllGenerals();
            for (let i = 0; i < allGenerals.length; i++) {
                const el = document.getElementById(`general_${i}`);
                const stateEl = document.getElementById(`generalState_${i}`);
                if ((el && el.value) || (stateEl && parseInt(stateEl.value) > 0)) hasAny = true;
            }
            return hasAny ? 'partial' : 'empty';
        }

        function checkAcademyComplete() {
            const fields = ['gokudenSword', 'gokudenBody', 'gokudenTech', 'gokudenHeart1', 'gokudenHeart2'];
            const gokudenHeiho = ['Momiji', 'Banseki', 'Shishi', 'Tengu', 'Attack', 'Defense', 'Combo', 'Resist', 'Shield', 'Pierce', 'Evade', 'Accuracy', 'Barrier'];
            
            let hasAny = false;
            fields.forEach(f => {
                if (document.getElementById(f).value) hasAny = true;
            });
            gokudenHeiho.forEach(h => {
                if (document.getElementById(`gokuden${h}_equipped`)?.checked) hasAny = true;
                if (document.getElementById(`gokuden${h}_owned`)?.checked) hasAny = true;
            });
            
            return hasAny ? 'partial' : 'empty';
        }

        function checkAsuraComplete() {
            let hasAny = false;
            ['asura30_1', 'asura30_2', 'asura30_3', 'asura60_1', 'asura60_2', 'asura60_3', 'asura60_4', 'asura60_5', 'asura90_1', 'asura90_2', 'asura90_3', 'asura90_4', 'asura90_5'].forEach(id => {
                if (document.getElementById(id)?.checked) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkArmorComplete() {
            let hasAny = false;
            ['genko', 'kirin', 'reikyo', 'kinen', 'hanya', 'kiou'].forEach(m => {
                if (document.getElementById(`mask_${m}_equipped`).checked) hasAny = true;
                if (document.getElementById(`mask_${m}_owned`).checked) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkFlowerComplete() {
            let hasAny = false;
            flowerFormations.forEach(f => {
                if (document.getElementById(`flower_${f.id}_equipped`).checked) hasAny = true;
                if (document.getElementById(`flower_${f.id}_owned`).checked) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkHorseComplete() {
            let hasAny = false;
            ['kago', 'kobu', 'hangeki'].forEach(h => {
                if (document.getElementById(`horse_${h}_gold`).value) hasAny = true;
                if (document.getElementById(`horse_${h}_silver`).value) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }

        function checkTacticComplete() {
            let hasAny = false;
            tactics.forEach(t => {
                if (document.getElementById(`tactic_${t.id}_equipped`).checked) hasAny = true;
                if (document.getElementById(`tactic_${t.id}_owned`).checked) hasAny = true;
            });
            return hasAny ? 'partial' : 'empty';
        }


        // ========== User Comparison ==========

        let selectedUsers = [];

        function refreshUserCheckboxGrid() {
            const grid = document.getElementById('userCheckboxGrid');
            const allData = cachedGameData;
            
            if (!allData || Object.keys(allData).length === 0) {
                grid.innerHTML = '<span style="color: var(--text-muted);">‰øùÂ≠ò„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
                return;
            }

            grid.innerHTML = Object.keys(allData).map(name => `
                <label class="user-checkbox ${selectedUsers.includes(name) ? 'selected' : ''}">
                    <input type="checkbox" ${selectedUsers.includes(name) ? 'checked' : ''} onchange="toggleUserSelection('${name}', this.checked)">
                    ${name}
                </label>
            `).join('');
        }

        function toggleUserSelection(username, checked) {
            if (checked && !selectedUsers.includes(username)) {
                if (selectedUsers.length >= 10) {
                    showToast('ÊúÄÂ§ß10‰∫∫„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô', 'error');
                    return;
                }
                selectedUsers.push(username);
            } else {
                selectedUsers = selectedUsers.filter(u => u !== username);
            }
            updateCompareButton();
            refreshUserCheckboxGrid();
        }

        function updateCompareButton() {
            const btn = document.getElementById('compareBtn');
            const display = document.getElementById('selectedUsersDisplay');

            if (selectedUsers.length >= 2) {
                btn.disabled = false;
                btn.textContent = `ÊØîËºÉÂàÜÊûê„ÇíÂÆüË°å (${selectedUsers.length}‰∫∫ÈÅ∏Êäû‰∏≠)`;
            } else {
                btn.disabled = true;
                btn.textContent = 'ÊØîËºÉÂàÜÊûê„ÇíÂÆüË°å (2‰∫∫‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ)';
            }

            display.innerHTML = selectedUsers.length > 0
                ? `<span style="color: var(--accent-gold);">ÈÅ∏Êäû‰∏≠: ${selectedUsers.join(', ')}</span>`
                : '';
        }

        function runComparison() {
            if (selectedUsers.length < 2) {
                showToast('2‰∫∫‰ª•‰∏ä„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const usersData = selectedUsers.map(name => ({ name, data: cachedGameData[name] }));
            const equippableItems = getEquippableItems();

            const equipped = [];
            const unused = [];
            const ownedNotEquipped = [];

            equippableItems.forEach(item => {
                const equippedBy = [];
                const ownedBy = [];
                const ownedButNotEquippedUsers = [];

                usersData.forEach(({ name, data }) => {
                    const status = getItemStatus(data, item);
                    if (status.equipped) {
                        equippedBy.push(name);
                    }
                    if (status.owned) {
                        ownedBy.push(name);
                        if (!status.equipped) {
                            ownedButNotEquippedUsers.push(name);
                        }
                    }
                });

                if (equippedBy.length >= 1) {
                    equipped.push({ ...item, users: equippedBy });
                }

                if (equippedBy.length === 0) {
                    unused.push({ ...item, ownedBy: ownedBy });
                }

                if (ownedButNotEquippedUsers.length > 0) {
                    ownedNotEquipped.push({ ...item, users: ownedButNotEquippedUsers });
                }
            });

            displayComparisonResults(equipped, unused, ownedNotEquipped);
        }

        function getEquippableItems() {
            const items = [];

            // Weapons
            ['Ëµ§È¨º', 'ÈöïÁü≥', 'Ëà¨Ëã•'].forEach((name, i) => {
                items.push({ id: ['akoni', 'inseki', 'hanya'][i], name, type: 'ÂÖµÂô®', category: 'weapon' });
            });

            // SP Generals
            const spGeneralNames = { nobunaga: 'SPÁπîÁî∞‰ø°Èï∑', hideyoshi: 'SPË±äËá£ÁßÄÂêâ', ieyasu: 'SPÂæ≥Â∑ùÂÆ∂Â∫∑' };
            Object.entries(spGeneralNames).forEach(([id, name]) => {
                items.push({ id, name, type: 'SPÊ≠¶Â∞Ü', category: 'spgeneral' });
            });

            // Regular Generals
            let globalIndex = 0;
            generalCategories.forEach((cat, catIndex) => {
                cat.generals.forEach((name, i) => {
                    items.push({ 
                        id: `general_${globalIndex}`, name, type: 'Ê≠¶Â∞Ü', category: 'general', 
                        index: globalIndex, generalName: name, subcategory: cat.title, subcategoryIndex: catIndex
                    });
                    globalIndex++;
                });
            });
            
            const customGenerals = cachedCustomGenerals || [];
            customGenerals.forEach((name, i) => {
                items.push({ 
                    id: `general_${globalIndex}`, name, type: 'Ê≠¶Â∞Ü', category: 'general', 
                    index: globalIndex, generalName: name, subcategory: 'ËøΩÂä†Ê≠¶Â∞Ü', subcategoryIndex: generalCategories.length
                });
                globalIndex++;
            });

            // Academy
            const gokudenHeiho = [
                { id: 'momiji', name: 'Á¥ÖËëâ' }, { id: 'banseki', name: 'Áõ§Áü≥' },
                { id: 'shishi', name: 'ÁçÖÂ≠ê„ÅÆÊ¥ûÂÖ•„Çä' }, { id: 'tengu', name: 'Â§©ÁãóÊäÑ' },
                { id: 'attack', name: 'ÊîªÊíÉ' }, { id: 'defense', name: 'Èò≤Âæ°' },
                { id: 'combo', name: 'ÈÄ£ÊíÉ' }, { id: 'resist', name: 'ÊäµÊäó' },
                { id: 'shield', name: 'Ê•ØÁ™Å' }, { id: 'pierce', name: 'Ë≤´ÈÄö' },
                { id: 'evade', name: 'ÂõûÈÅø' }, { id: 'accuracy', name: 'ÂëΩ‰∏≠' },
                { id: 'barrier', name: 'ÈöúÂ£Å' }
            ];
            gokudenHeiho.forEach(h => {
                items.push({ id: h.id, name: h.name, type: 'Ê•µ‰ºùÂÖµÊ≥ï', category: 'academy' });
            });

            // Masks
            const maskNames = { genko: 'ÁéÑÁãêÁ•û‰Ωø', kirin: 'ÈáëÈ∫íÈ∫ü', reikyo: 'ÈúäÊ£ò', kinen: 'ÈáëÁåø', hanya: 'Ëà¨Ëã•', kiou: 'È¨ºÁéã' };
            Object.entries(maskNames).forEach(([id, name]) => {
                items.push({ id, name, type: 'Ê†∏ÂøÉÂÖ∑Ë∂≥', category: 'mask' });
            });

            // Flowers
            flowerFormations.forEach(f => {
                items.push({ id: f.id, name: f.name, type: 'Ëä±Èô£', category: 'flower', effect: f.effect });
            });

            // Tactics
            tactics.forEach(t => {
                items.push({ id: t.id, name: t.name, type: 'Êà¶Ê≥ï', category: 'tactic' });
            });

            // Asura skills
            const asura30 = ['ÂéÑÊÜë', 'ÈáëÂâõ„ÅÆÈéß', 'Á®≤Áî∞Â∑°Á§º'];
            const asura60 = ['ÁßªËä±Êé•Êú®', 'ÊîªÂÆàËª¢Êèõ', 'È¢®Âä©ÁÅ´Âã¢', '‰øäÊïèÁã°Áåæ', 'ÂÆàÊîªËª¢Êèõ'];
            const asura90 = ['Á†¥ÂøÉÊñ≠È™®', 'ÈÅ©ÊôÇÂá∫ÊíÉ', 'È∫íÈ∫ü„ÅÆÊ∏Ö„ÇÅ', 'Èö†ÂàÉ', 'Ë°ÄÊàÆ'];
            
            asura30.forEach((name, i) => {
                items.push({ id: `asura30_${i+1}`, name, type: 'Èòø‰øÆÁæÖ30', category: 'asura', subcategory: 'asura30', index: i });
            });
            asura60.forEach((name, i) => {
                items.push({ id: `asura60_${i+1}`, name, type: 'Èòø‰øÆÁæÖ60', category: 'asura', subcategory: 'asura60', index: i });
            });
            asura90.forEach((name, i) => {
                items.push({ id: `asura90_${i+1}`, name, type: 'Èòø‰øÆÁæÖ90', category: 'asura', subcategory: 'asura90', index: i });
            });

            return items;
        }

        function getItemStatus(data, item) {
            let equipped = false;
            let owned = false;

            switch(item.category) {
                case 'weapon':
                    const weaponData = data?.weapons?.[item.id];
                    equipped = weaponData?.status === 'equipped';
                    owned = weaponData?.status === 'owned' || weaponData?.status === 'equipped';
                    break;
                case 'spgeneral':
                    const spData = data?.spGenerals?.[item.id];
                    equipped = spData?.formed || false;
                    owned = spData?.owned || false;
                    break;
                case 'general':
                    const generalData = data?.generals?.[item.generalName];
                    if (generalData && typeof generalData === 'object') {
                        equipped = generalData.formed || false;
                        owned = generalData.owned || false;
                    }
                    break;
                case 'academy':
                    const heihoData = data?.academy?.heiho?.[item.id];
                    equipped = heihoData?.equipped || false;
                    owned = heihoData?.owned || false;
                    break;
                case 'mask':
                    const maskData = data?.armor?.masks?.[item.id];
                    equipped = maskData?.equipped || false;
                    owned = maskData?.owned || false;
                    break;
                case 'flower':
                    const flowerData = data?.flowers?.[item.id];
                    equipped = flowerData?.equipped || false;
                    owned = flowerData?.owned || false;
                    break;
                case 'tactic':
                    const tacticData = data?.tactics?.[item.id];
                    equipped = tacticData?.equipped || false;
                    owned = tacticData?.owned || false;
                    break;
                case 'asura':
                    if (item.subcategory === 'asura30') {
                        equipped = data?.asura?.skills30?.[item.index] || false;
                    } else if (item.subcategory === 'asura60') {
                        equipped = data?.asura?.skills60?.[item.index] || false;
                    } else if (item.subcategory === 'asura90') {
                        equipped = data?.asura?.skills90?.[item.index] || false;
                    }
                    owned = equipped;
                    break;
            }
            return { equipped, owned };
        }


        function displayComparisonResults(overlaps, unused, ownedNotEquipped) {
            const resultsDiv = document.getElementById('comparisonResults');
            resultsDiv.classList.add('show');

            const categoryStyles = {
                'weapon': { class: 'subcat-weapon', label: '‚ë† ÂÖµÂô®', icon: '‚öîÔ∏è', order: 1 },
                'spgeneral': { class: 'subcat-spgeneral', label: '‚ë°-1 SPÊ≠¶Â∞Ü', icon: 'üëë', order: 2 },
                'general': { class: 'subcat-general', label: '‚ë°-2 Ê≠¶Â∞Ü', icon: 'üéñÔ∏è', order: 3, hasSubcategory: true },
                'academy': { class: 'subcat-academy', label: '‚ë¢ Ê•µ‰ºùÂÖµÊ≥ï', icon: 'üìö', order: 4 },
                'asura': { class: 'subcat-asura', label: '‚ë£ Èòø‰øÆÁæÖ', icon: 'üëπ', order: 5, hasSubcategory: true },
                'mask': { class: 'subcat-mask', label: '‚ë§ Ê†∏ÂøÉÂÖ∑Ë∂≥', icon: 'üé≠', order: 6 },
                'flower': { class: 'subcat-flower', label: '‚ë• Ëä±Èô£', icon: 'üå∏', order: 7 },
                'horse': { class: 'subcat-horse', label: '‚ë¶ ËªçÈ¶¨', icon: 'üê¥', order: 8 },
                'tactic': { class: 'subcat-tactic', label: '‚ëß Êà¶Ê≥ï', icon: 'üìú', order: 9 }
            };

            const asuraSubcatLabels = { 'asura30': 'Èòø‰øÆÁæÖ30', 'asura60': 'Èòø‰øÆÁæÖ60', 'asura90': 'Èòø‰øÆÁæÖ90' };
            const generalSubcatLabels = {};
            generalCategories.forEach(cat => { generalSubcatLabels[cat.title] = cat.title; });
            generalSubcatLabels['ËøΩÂä†Ê≠¶Â∞Ü'] = 'ËøΩÂä†Ê≠¶Â∞Ü';

            function groupByCategory(items) {
                const groups = {};
                items.forEach(item => {
                    const cat = item.category;
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });
                return groups;
            }

            function groupBySubcategory(items) {
                const groups = {};
                items.forEach(item => {
                    const subcat = item.subcategory || 'default';
                    if (!groups[subcat]) groups[subcat] = [];
                    groups[subcat].push(item);
                });
                return groups;
            }

            function sortCategories(groups) {
                return Object.entries(groups).sort((a, b) => {
                    const orderA = categoryStyles[a[0]]?.order || 99;
                    const orderB = categoryStyles[b[0]]?.order || 99;
                    return orderA - orderB;
                });
            }

            function renderItem(item) {
                if (item.category === 'horse') {
                    return `<div class="comparison-item"><div><span class="item-name">${item.name}</span><span class="item-type">${item.type}</span></div><div class="users-list">${item.details.map(d => `<span class="user-tag">${d.user}: Èáë${d.gold} ÈäÄ${d.silver}</span>`).join('')}</div></div>`;
                }
                if (item.users) {
                    return `<div class="comparison-item"><div><span class="item-name">${item.name}</span><span class="item-type">${item.type}</span></div><div class="users-list">${item.users.map(u => `<span class="user-tag">${u}</span>`).join('')}</div></div>`;
                }
                if (item.ownedBy !== undefined) {
                    return `<div class="comparison-item"><div><span class="item-name">${item.name}</span><span class="item-type">${item.type}</span></div><div class="users-list">${item.ownedBy.length > 0 ? item.ownedBy.map(u => `<span class="user-tag">${u}(ÊâÄÊåÅ)</span>`).join('') : '<span style="color: var(--text-muted); font-size: 0.8rem;">Ë™∞„ÇÇÊâÄÊåÅ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</span>'}</div></div>`;
                }
                return '';
            }

            function renderLevel3(items) { return items.map(renderItem).join(''); }

            function renderLevel2(cat, items, style) {
                const subcatGroups = groupBySubcategory(items);
                if (style.hasSubcategory && Object.keys(subcatGroups).length > 0) {
                    const subcatLabels = cat === 'general' ? generalSubcatLabels : asuraSubcatLabels;
                    let sortedSubcats;
                    if (cat === 'general') {
                        sortedSubcats = Object.entries(subcatGroups).sort((a, b) => {
                            const indexA = items.find(i => i.subcategory === a[0])?.subcategoryIndex ?? 99;
                            const indexB = items.find(i => i.subcategory === b[0])?.subcategoryIndex ?? 99;
                            return indexA - indexB;
                        });
                    } else {
                        const asuraOrder = { 'asura30': 1, 'asura60': 2, 'asura90': 3 };
                        sortedSubcats = Object.entries(subcatGroups).sort((a, b) => (asuraOrder[a[0]] || 99) - (asuraOrder[b[0]] || 99));
                    }
                    return sortedSubcats.map(([subcat, subItems]) => {
                        const subcatId = `subcat2_${cat}_${subcat}_${Math.random().toString(36).substr(2, 9)}`;
                        const label = subcatLabels[subcat] || subcat;
                        return `<div class="comparison-level-2"><div class="comparison-subcategory-header" style="padding: 0.5rem 0.8rem; font-size: 0.85rem;" onclick="toggleSubcategory('${subcatId}')"><span class="subcat-title"><span>‚óè</span>${label}<span class="subcat-count">${subItems.length}‰ª∂</span></span><span class="toggle-icon">‚ñ∂</span></div><div class="comparison-subcategory-content comparison-level-3" id="${subcatId}">${renderLevel3(subItems)}</div></div>`;
                    }).join('');
                }
                return renderLevel3(items);
            }

            function renderSubcategories(groups) {
                if (Object.keys(groups).length === 0) return '<div class="no-issues"><div class="icon">‚úì</div>Ë©≤ÂΩì„Å™„Åó</div>';
                const sortedGroups = sortCategories(groups);
                return sortedGroups.map(([cat, items]) => {
                    const style = categoryStyles[cat] || { class: '', label: cat, icon: 'üìã', order: 99 };
                    const subcatId = `subcat_${cat}_${Math.random().toString(36).substr(2, 9)}`;
                    return `<div class="comparison-subcategory"><div class="comparison-subcategory-header ${style.class}" onclick="toggleSubcategory('${subcatId}')"><span class="subcat-title"><span>${style.icon}</span>${style.label}<span class="subcat-count">${items.length}‰ª∂</span></span><span class="toggle-icon">‚ñ∂</span></div><div class="comparison-subcategory-content" id="${subcatId}">${renderLevel2(cat, items, style)}</div></div>`;
                }).join('');
            }

            // Horse analysis
            const usersData = selectedUsers.map(name => ({ name, data: cachedGameData[name] }));
            const horseAnalysis = analyzeHorseSkills(usersData);
            if (horseAnalysis.overlaps.length > 0) {
                horseAnalysis.overlaps.forEach(item => overlaps.push(item));
            }

            const overlapGroups = groupByCategory(overlaps);
            document.getElementById('overlapCount').textContent = `${overlaps.length}‰ª∂`;
            document.getElementById('overlapContent').innerHTML = renderSubcategories(overlapGroups);

            const unusedGroups = groupByCategory(unused);
            document.getElementById('unusedCount').textContent = `${unused.length}‰ª∂`;
            document.getElementById('unusedContent').innerHTML = renderSubcategories(unusedGroups);

            const ownedNotEquippedGroups = groupByCategory(ownedNotEquipped);
            document.getElementById('inconsistentCount').textContent = `${ownedNotEquipped.length}‰ª∂`;
            document.getElementById('inconsistentContent').innerHTML = renderSubcategories(ownedNotEquippedGroups);

            showToast('ÊØîËºÉÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
        }

        function analyzeHorseSkills(usersData) {
            const overlaps = [];
            const horseTypes = [
                { key: 'kago', name: 'Èßí„ÉªÂä†Ë≠∑', type: '„ÉÄ„É°„Éº„Ç∏Ê∏õ' },
                { key: 'kobu', name: 'Èßí„ÉªÈºìËàû', type: '„ÉÄ„É°„Éº„Ç∏Â¢ó' },
                { key: 'hangeki', name: 'Èßí„ÉªÂèçÊíÉ', type: '„ÉÄ„É°„Éº„Ç∏Ë∑≥„Å≠Ëøî„Åó' }
            ];
            horseTypes.forEach(horseType => {
                const usersWithSkill = [];
                usersData.forEach(({ name, data }) => {
                    const horseData = data?.horse?.[horseType.key];
                    const gold = parseInt(horseData?.gold) || 0;
                    const silver = parseInt(horseData?.silver) || 0;
                    if (gold > 0 || silver > 0) {
                        usersWithSkill.push({ user: name, gold, silver });
                    }
                });
                if (usersWithSkill.length > 1) {
                    const totalGold = usersWithSkill.reduce((sum, u) => sum + u.gold, 0);
                    const totalSilver = usersWithSkill.reduce((sum, u) => sum + u.silver, 0);
                    overlaps.push({
                        name: `${horseType.name}ÔºàÈáëË®à${totalGold} / ÈäÄË®à${totalSilver}Ôºâ`,
                        type: horseType.type, category: 'horse', details: usersWithSkill
                    });
                }
            });
            return { overlaps };
        }

        function toggleSubcategory(subcatId) {
            const content = document.getElementById(subcatId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.textContent = '‚ñ∂';
            } else {
                content.classList.add('show');
                icon.textContent = '‚ñº';
            }
        }

        function toggleComparisonCategory(categoryId) {
            const content = document.querySelector(`#${categoryId} .comparison-category-content`);
            const header = document.querySelector(`#${categoryId} .comparison-category-header`);
            const icon = header.querySelector('.toggle-icon');
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.textContent = '‚ñ∂';
            } else {
                content.classList.add('show');
                icon.textContent = '‚ñº';
            }
        }


        // ========== Bulk Select Functions ==========

        function bulkSelectWeapons(action) {
            const weapons = ['akoni', 'inseki', 'hanya'];
            weapons.forEach(w => {
                const select = document.getElementById(`${w}Status`);
                if (select) select.value = action === 'owned' ? 'owned' : '';
            });
            updateProgress();
            updateSummary();
        }

        function bulkSelectGenerals(category, action) {
            const categoryMap = { 'all': null, 'want': 0, 'gather': 1, 'alltype': 2, 'horse': 3, 'infantry': 4, 'bow': 5 };
            const allGenerals = getAllGenerals();
            let startIndex = 0;
            
            if (category === 'all') {
                for (let i = 0; i < allGenerals.length; i++) {
                    setGeneralState(i, action === 'owned' ? 1 : 0);
                }
            } else {
                const catIndex = categoryMap[category];
                if (catIndex !== undefined && catIndex < generalCategories.length) {
                    for (let i = 0; i < catIndex; i++) {
                        startIndex += generalCategories[i].generals.length;
                    }
                    const count = generalCategories[catIndex].generals.length;
                    for (let i = startIndex; i < startIndex + count; i++) {
                        setGeneralState(i, action === 'owned' ? 1 : 0);
                    }
                }
            }
            updateProgress();
            updateSummary();
            updateFormationCount();
        }

        function setGeneralState(index, state) {
            const item = document.getElementById(`generalItem_${index}`);
            const hiddenInput = document.getElementById(`generalState_${index}`);
            if (item && hiddenInput) {
                item.dataset.state = state;
                hiddenInput.value = state;
                item.classList.remove('owned', 'formed');
                if (state === 1) item.classList.add('owned');
                else if (state === 2) item.classList.add('formed');
            }
        }

        function bulkSelectAcademy(action) {
            const gokudenHeiho = ['Momiji', 'Banseki', 'Shishi', 'Tengu', 'Attack', 'Defense', 'Combo', 'Resist', 'Shield', 'Pierce', 'Evade', 'Accuracy', 'Barrier'];
            gokudenHeiho.forEach(h => {
                const owned = document.getElementById(`gokuden${h}_owned`);
                if (owned) owned.checked = action === 'owned';
                if (action === 'clear') {
                    const equipped = document.getElementById(`gokuden${h}_equipped`);
                    if (equipped) equipped.checked = false;
                }
            });
            updateProgress();
            updateSummary();
        }

        function bulkSelectMasks(action) {
            const masks = ['genko', 'kirin', 'reikyo', 'kinen', 'hanya', 'kiou'];
            masks.forEach(m => {
                const owned = document.getElementById(`mask_${m}_owned`);
                if (owned) owned.checked = action === 'owned';
                if (action === 'clear') {
                    const equipped = document.getElementById(`mask_${m}_equipped`);
                    if (equipped) equipped.checked = false;
                }
            });
            updateProgress();
            updateSummary();
        }

        function bulkSelectFlowers(action) {
            flowerFormations.forEach(f => {
                const owned = document.getElementById(`flower_${f.id}_owned`);
                if (owned) owned.checked = action === 'owned';
                if (action === 'clear') {
                    const equipped = document.getElementById(`flower_${f.id}_equipped`);
                    if (equipped) equipped.checked = false;
                }
            });
            updateProgress();
            updateSummary();
        }

        function bulkSelectTactics(action) {
            tactics.forEach(t => {
                const owned = document.getElementById(`tactic_${t.id}_owned`);
                if (owned) owned.checked = action === 'owned';
                if (action === 'clear') {
                    const equipped = document.getElementById(`tactic_${t.id}_equipped`);
                    if (equipped) equipped.checked = false;
                }
            });
            updateProgress();
            updateSummary();
        }

        // ========== Floating Navigation ==========

        function toggleFloatingMenu() {
            const menu = document.getElementById('floatingMenu');
            menu.classList.toggle('show');
        }

        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (section.classList.contains('collapsed')) {
                    section.classList.remove('collapsed');
                }
            }
            toggleFloatingMenu();
        }

        document.addEventListener('click', function(e) {
            const nav = document.querySelector('.floating-nav');
            if (nav && !nav.contains(e.target)) {
                document.getElementById('floatingMenu').classList.remove('show');
            }
        });

        // ========== Formation Count ==========

        function updateFormationCount() {
            let count = 0;
            ['nobunaga', 'hideyoshi', 'ieyasu'].forEach(sp => {
                if (document.getElementById(`${sp}Formed`)?.checked) count++;
            });
            const allGenerals = getAllGenerals();
            for (let i = 0; i < allGenerals.length; i++) {
                const state = document.getElementById(`generalState_${i}`)?.value;
                if (state === '2') count++;
            }
            document.getElementById('totalFormationCount').innerHTML = `${count}<span>‰∫∫</span>`;
        }

        // ========== Summary Update ==========

        function updateSummary() {
            // Weapon
            let weaponEquipped = 0, weaponTotal = 0;
            ['akoni', 'inseki', 'hanya'].forEach(w => {
                const status = document.getElementById(`${w}Status`)?.value;
                if (status === 'equipped') { weaponEquipped++; weaponTotal++; }
                else if (status === 'owned') { weaponTotal++; }
            });
            document.getElementById('summary_weapon_equipped').textContent = `${weaponEquipped}/3`;
            document.getElementById('summary_weapon_total').textContent = `${weaponTotal}/3`;

            // SP General
            let spEquipped = 0, spTotal = 0;
            ['nobunaga', 'hideyoshi', 'ieyasu'].forEach(sp => {
                const formed = document.getElementById(`${sp}Formed`)?.checked;
                const owned = document.getElementById(`${sp}Owned`)?.checked;
                if (formed) { spEquipped++; spTotal++; }
                else if (owned) { spTotal++; }
            });
            document.getElementById('summary_sp_equipped').textContent = `${spEquipped}/3`;
            document.getElementById('summary_sp_total').textContent = `${spTotal}/3`;

            // General
            const allGenerals = getAllGenerals();
            let generalEquipped = 0, generalTotal = 0;
            for (let i = 0; i < allGenerals.length; i++) {
                const state = parseInt(document.getElementById(`generalState_${i}`)?.value || '0');
                if (state === 2) { generalEquipped++; generalTotal++; }
                else if (state === 1) { generalTotal++; }
            }
            document.getElementById('summary_general_equipped').textContent = `${generalEquipped}/${allGenerals.length}`;
            document.getElementById('summary_general_total').textContent = `${generalTotal}/${allGenerals.length}`;

            // Academy
            const gokudenHeiho = ['Momiji', 'Banseki', 'Shishi', 'Tengu', 'Attack', 'Defense', 'Combo', 'Resist', 'Shield', 'Pierce', 'Evade', 'Accuracy', 'Barrier'];
            let academyEquipped = 0, academyTotal = 0;
            gokudenHeiho.forEach(h => {
                const equipped = document.getElementById(`gokuden${h}_equipped`)?.checked;
                const owned = document.getElementById(`gokuden${h}_owned`)?.checked;
                if (equipped) { academyEquipped++; academyTotal++; }
                else if (owned) { academyTotal++; }
            });
            document.getElementById('summary_academy_equipped').textContent = `${academyEquipped}/13`;
            document.getElementById('summary_academy_total').textContent = `${academyTotal}/13`;

            // Asura
            let asuraEquipped = 0;
            ['asura30_1', 'asura30_2', 'asura30_3', 'asura60_1', 'asura60_2', 'asura60_3', 'asura60_4', 'asura60_5', 'asura90_1', 'asura90_2', 'asura90_3', 'asura90_4', 'asura90_5'].forEach(id => {
                if (document.getElementById(id)?.checked) asuraEquipped++;
            });
            document.getElementById('summary_asura_equipped').textContent = `${asuraEquipped}/13`;

            // Mask
            let maskEquipped = 0, maskTotal = 0;
            ['genko', 'kirin', 'reikyo', 'kinen', 'hanya', 'kiou'].forEach(m => {
                const equipped = document.getElementById(`mask_${m}_equipped`)?.checked;
                const owned = document.getElementById(`mask_${m}_owned`)?.checked;
                if (equipped) { maskEquipped++; maskTotal++; }
                else if (owned) { maskTotal++; }
            });
            document.getElementById('summary_mask_equipped').textContent = `${maskEquipped}/6`;
            document.getElementById('summary_mask_total').textContent = `${maskTotal}/6`;

            // Flower
            let flowerEquipped = 0, flowerTotal = 0;
            flowerFormations.forEach(f => {
                const equipped = document.getElementById(`flower_${f.id}_equipped`)?.checked;
                const owned = document.getElementById(`flower_${f.id}_owned`)?.checked;
                if (equipped) { flowerEquipped++; flowerTotal++; }
                else if (owned) { flowerTotal++; }
            });
            document.getElementById('summary_flower_equipped').textContent = `${flowerEquipped}/32`;
            document.getElementById('summary_flower_total').textContent = `${flowerTotal}/32`;

            // Tactic
            let tacticEquipped = 0, tacticTotal = 0;
            tactics.forEach(t => {
                const equipped = document.getElementById(`tactic_${t.id}_equipped`)?.checked;
                const owned = document.getElementById(`tactic_${t.id}_owned`)?.checked;
                if (equipped) { tacticEquipped++; tacticTotal++; }
                else if (owned) { tacticTotal++; }
            });
            document.getElementById('summary_tactic_equipped').textContent = `${tacticEquipped}/6`;
            document.getElementById('summary_tactic_total').textContent = `${tacticTotal}/6`;
        }

        // ========== Toast Notification ==========

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
